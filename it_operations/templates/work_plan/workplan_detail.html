{% extends 'dashboard.html' %}
{% block title %}Plan Details{% endblock %}

{% block content %}
<div class="container mx-auto p-4 lg:p-6 animate-fade-in">

    <!-- Server Messages -->
    {% if messages %}
    <div class="mb-5 space-y-2">
        {% for message in messages %}
        <div class="p-4 rounded-xl shadow-sm flex items-center gap-3 border
            {% if message.tags == 'success' %}bg-green-50 text-green-800 border-green-200
            {% elif message.tags == 'error' %}bg-red-50 text-red-800 border-red-200
            {% elif message.tags == 'info' %}bg-blue-50 text-blue-800 border-blue-200
            {% elif message.tags == 'warning' %}bg-yellow-50 text-yellow-800 border-yellow-200
            {% else %}bg-gray-50 text-gray-800 border-gray-200{% endif %}">
            <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
                {% if message.tags == 'success' %}bg-green-100
                {% elif message.tags == 'error' %}bg-red-100
                {% elif message.tags == 'warning' %}bg-yellow-100
                {% else %}bg-blue-100{% endif %}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    {% if message.tags == 'success' %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                    {% elif message.tags == 'error' %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                    {% elif message.tags == 'warning' %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    {% else %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    {% endif %}
                </svg>
            </div>
            <span class="font-medium text-sm">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ===== PAGE HEADER ===== -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

            <!-- Left: Title & Meta -->
            <div class="min-w-0">
                <div class="flex flex-wrap items-center gap-2 mb-1">
                    <span class="text-xs font-bold uppercase tracking-widest text-gray-400">Work Plan</span>
                    {% if is_collaborator and not is_owner %}
                    <span class="px-2.5 py-0.5 bg-purple-100 text-purple-700 text-xs font-bold rounded-full uppercase tracking-wide">Collaborating</span>
                    {% endif %}
                </div>
                <h1 class="text-2xl lg:text-3xl font-bold text-primary leading-tight">
                    <span class="text-accent">{{ work_plan.week_start_date|date:"M d" }}</span>
                    <span class="text-gray-400 font-normal mx-1">—</span>
                    {{ work_plan.week_end_date|date:"M d, Y" }}
                </h1>
                <div class="flex flex-wrap items-center gap-3 mt-2">
                    <div class="flex items-center gap-1.5 text-sm text-gray-600">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span class="font-semibold text-gray-700">{{ work_plan.user.get_full_name }}</span>
                    </div>
                    {% if manager_override_creation_open and is_current_week_plan and creation_deadline_passed %}
                    <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-emerald-50 text-emerald-700 text-xs font-bold rounded-full border border-emerald-200">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg>
                        Manager Override Active
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- Right: Action Buttons -->
            <div class="flex flex-wrap items-center gap-2 lg:flex-nowrap lg:shrink-0">

                {% if manager_can_toggle_creation %}
                <form method="post" action="{% url 'work_plan_toggle_creation_override' work_plan.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="{% if manager_override_creation_open %}close{% else %}open{% endif %}">
                    <button type="submit" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-bold shadow-sm transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md
                        {% if manager_override_creation_open %}bg-orange-500 hover:bg-orange-600 text-white{% else %}bg-emerald-500 hover:bg-emerald-600 text-white{% endif %}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            {% if manager_override_creation_open %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            {% else %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                            {% endif %}
                        </svg>
                        {% if manager_override_creation_open %}Close Plan Creation{% else %}Reopen Plan Creation{% endif %}
                    </button>
                </form>
                {% endif %}

                <a href="{% url 'download_workplan_pdf' work_plan.id %}" class="inline-flex items-center gap-2 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-xl text-sm font-bold shadow-sm transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export PDF
                </a>

                <a href="{% url 'work_plan_list' %}" class="inline-flex items-center gap-2 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl text-sm font-bold transition-all duration-200 hover:-translate-y-0.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Back to List
                </a>

            </div>
        </div>
    </div>
    <!-- ===== END PAGE HEADER ===== -->

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

        <!-- ===== LEFT PANEL: ADD TASK / LOCKED ===== -->
        <div class="xl:col-span-1">
            {% if can_add_tasks %}
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 border-t-4 border-t-accent p-6 sticky top-24">
                    <h3 class="text-lg font-bold text-primary mb-5 flex items-center gap-2">
                        <span class="w-7 h-7 bg-accent/10 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/>
                            </svg>
                        </span>
                        Add New Task
                    </h3>

                    <form method="post" id="addTaskForm">
                        {% csrf_token %}
                        <input type="hidden" name="add_task" value="1">

                        <!-- Leave Toggle -->
                        <label class="flex items-center gap-3 p-3 bg-yellow-50 border border-yellow-200 rounded-xl mb-5 cursor-pointer hover:bg-yellow-100 transition">
                            <input type="checkbox" name="is_leave" id="is_leave_checkbox" onchange="toggleLeaveMode()" class="w-4 h-4 text-yellow-600 rounded focus:ring-yellow-500 cursor-pointer">
                            <div>
                                <span class="text-sm font-bold text-yellow-800 block">Mark as "On Leave"</span>
                                <span class="text-xs text-yellow-600">Blocks the day; existing tasks will be moved</span>
                            </div>
                        </label>

                        <div class="space-y-4 normal-fields transition-opacity duration-200">

                            <!-- Date -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1.5">Date</label>
                                <select name="date" required id="date_select" class="w-full rounded-xl border border-gray-200 bg-gray-50 px-3 py-2.5 text-sm focus:ring-2 focus:ring-accent focus:border-accent outline-none transition">
                                    {% for day in week_days %}
                                        {% with day_str=day|date:"Y-m-d" %}
                                            {% if day_str in leave_dates %}
                                                <option value="{{ day_str }}" disabled class="text-yellow-700 bg-yellow-50">
                                                    {{ day|date:"l, M d" }} — On Leave
                                                </option>
                                            {% else %}
                                                <option value="{{ day_str }}">{{ day|date:"l, M d" }}</option>
                                            {% endif %}
                                        {% endwith %}
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Task Name -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1.5">Task Name</label>
                                <input type="text" name="task_name" id="task_name_input" required placeholder="e.g., Configure new firewall"
                                    class="w-full rounded-xl border border-gray-200 bg-gray-50 px-3 py-2.5 text-sm focus:ring-2 focus:ring-accent focus:border-accent outline-none transition">
                            </div>

                            <!-- Centre & Department -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1.5">Centre</label>
                                    <select name="centre" class="w-full rounded-xl border border-gray-200 bg-gray-50 px-3 py-2.5 text-sm focus:ring-2 focus:ring-accent outline-none transition">
                                        <option value="">— None —</option>
                                        {% for centre in centres %}
                                        <option value="{{ centre.id }}">{{ centre.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1.5">Department</label>
                                    <select name="department" class="w-full rounded-xl border border-gray-200 bg-gray-50 px-3 py-2.5 text-sm focus:ring-2 focus:ring-accent outline-none transition">
                                        <option value="">— None —</option>
                                        {% for dept in departments %}
                                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Collaborators -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1.5">Collaborators</label>
                                <select name="collaborators" multiple class="w-full rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-sm h-24 custom-scrollbar focus:ring-2 focus:ring-accent outline-none">
                                    {% for user in potential_collaborators %}
                                    <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                                <p class="text-[10px] text-gray-400 mt-1">Hold Ctrl / Cmd to select multiple.</p>
                            </div>

                            <!-- Resources & Outcome -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1.5">Resources &amp; Outcome</label>
                                <textarea name="resources_needed" rows="2" placeholder="Resources needed…"
                                    class="w-full rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-sm mb-2 focus:ring-2 focus:ring-accent outline-none transition resize-none"></textarea>
                                <textarea name="target" rows="2" placeholder="Target outcome…"
                                    class="w-full rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-sm focus:ring-2 focus:ring-accent outline-none transition resize-none"></textarea>
                            </div>
                        </div>

                        <button type="submit" class="w-full mt-5 py-3 bg-primary text-white rounded-xl font-bold shadow hover:bg-opacity-90 hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5 text-sm">
                            Add Task to Plan
                        </button>
                    </form>
                </div>

            {% else %}
                <!-- Locked / View-Only Panel -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 border-t-4 border-t-gray-300 p-8 sticky top-24 text-center">
                    <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-5 text-gray-400">
                        {% if is_owner %}
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                        {% else %}
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        {% endif %}
                    </div>

                    <h3 class="text-lg font-bold text-gray-700 mb-2">
                        {% if is_owner %}Planning Locked{% else %}View Only Mode{% endif %}
                    </h3>
                    <p class="text-sm text-gray-500 leading-relaxed mb-5">
                        {% if is_owner %}
                            The deadline to add new tasks for this week (Monday 10:00 AM) has passed. You can still update the status of your existing tasks.
                        {% else %}
                            You are viewing <strong>{{ work_plan.user.get_full_name }}'s</strong> work plan. You can interact with tasks assigned to you.
                        {% endif %}
                    </p>

                    {% if manager_can_toggle_creation %}
                    <form method="post" action="{% url 'work_plan_toggle_creation_override' work_plan.id %}" class="mb-4">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="{% if manager_override_creation_open %}close{% else %}open{% endif %}">
                        <button type="submit" class="w-full px-4 py-2.5 rounded-xl text-sm font-bold shadow-sm transition-all duration-200 hover:-translate-y-0.5
                            {% if manager_override_creation_open %}bg-orange-500 hover:bg-orange-600 text-white{% else %}bg-emerald-500 hover:bg-emerald-600 text-white{% endif %}">
                            {% if manager_override_creation_open %}Close Plan Creation{% else %}Reopen Plan Creation{% endif %}
                        </button>
                    </form>
                    {% endif %}

                    <span class="inline-block px-3 py-1 bg-gray-100 text-gray-500 text-xs font-bold rounded-full uppercase tracking-wide">
                        {% if is_owner %}Read Only{% else %}Collaborator / Manager Access{% endif %}
                    </span>
                </div>
            {% endif %}
        </div>

        <!-- ===== RIGHT PANEL: TASK LIST ===== -->
        <div class="xl:col-span-2 space-y-6">
            {% regroup tasks|dictsort:"date" by date as task_days %}
            {% for day in task_days %}

            <div>
                <!-- Day Header -->
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex flex-col items-center justify-center w-12 h-12 rounded-xl {% if day.grouper == today_date %}bg-accent text-white{% else %}bg-gray-100 text-gray-600{% endif %} shadow-sm flex-shrink-0">
                        <span class="text-[10px] font-extrabold uppercase leading-none tracking-wider">{{ day.grouper|date:"D" }}</span>
                        <span class="text-lg font-black leading-tight">{{ day.grouper|date:"d" }}</span>
                    </div>
                    <div class="flex-1 border-b border-gray-200 pb-2">
                        <div class="flex items-center gap-2">
                            <h3 class="text-base font-bold text-gray-700">{{ day.grouper|date:"F d, Y" }}</h3>
                            {% if day.grouper == today_date %}
                            <span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Today</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Tasks for the Day -->
                <div class="space-y-3 ml-0 lg:ml-16">
                    {% for task in day.list %}
                    <div class="group relative flex flex-col md:flex-row rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:-translate-y-0.5 hover:shadow-md
                        {% if task.is_collaborative_task %}bg-purple-50/60{% else %}bg-white{% endif %}">

                        <!-- Left Accent Bar -->
                        <div class="hidden md:block w-1 flex-shrink-0
                            {% if task.is_leave %}bg-yellow-400
                            {% elif task.status == 'Completed' %}bg-green-500
                            {% elif task.status == 'Not Done' %}bg-red-500
                            {% elif task.status == 'Rescheduled' %}bg-orange-500
                            {% else %}bg-blue-500{% endif %}">
                        </div>

                        <!-- Mobile top bar -->
                        <div class="md:hidden h-1 w-full
                            {% if task.is_leave %}bg-yellow-400
                            {% elif task.status == 'Completed' %}bg-green-500
                            {% elif task.status == 'Not Done' %}bg-red-500
                            {% elif task.status == 'Rescheduled' %}bg-orange-500
                            {% else %}bg-blue-500{% endif %}">
                        </div>

                        <!-- Task Content -->
                        <div class="flex-grow p-4 md:p-5 min-w-0">
                            <div class="flex flex-wrap justify-between items-start gap-2 mb-2">
                                <h4 class="text-sm font-bold text-gray-800 leading-snug flex-1 min-w-0">
                                    {% if task.is_leave %}
                                    <span class="inline-flex items-center gap-1 mr-1 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs font-bold rounded">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                        On Leave
                                    </span>
                                    {% endif %}
                                    {{ task.task_name }}
                                    {% if task.is_collaborative_task %}
                                    <span class="ml-2 px-2 py-0.5 text-xs font-bold bg-purple-200 text-purple-800 rounded-full">Collab</span>
                                    {% endif %}
                                </h4>
                                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold whitespace-nowrap
                                    {% if task.status == 'Completed' %}bg-green-100 text-green-800
                                    {% elif task.status == 'Not Done' %}bg-red-100 text-red-800
                                    {% elif task.status == 'Rescheduled' %}bg-orange-100 text-orange-800
                                    {% else %}bg-blue-100 text-blue-800{% endif %}">
                                    <span class="w-1.5 h-1.5 rounded-full
                                        {% if task.status == 'Completed' %}bg-green-500
                                        {% elif task.status == 'Not Done' %}bg-red-500
                                        {% elif task.status == 'Rescheduled' %}bg-orange-500
                                        {% else %}bg-blue-500{% endif %}">
                                    </span>
                                    {{ task.status }}
                                </span>
                            </div>

                            {% if task.is_collaborative_task %}
                            <p class="text-xs text-purple-700 font-semibold mb-2">
                                Owner: {{ task.work_plan.user.get_full_name }}
                            </p>
                            {% endif %}

                            {% if task.target or task.resources_needed or task.other_parties %}
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600 mt-2">
                                {% if task.target %}
                                <p><span class="font-bold text-gray-400 uppercase mr-1">Target:</span>{{ task.target }}</p>
                                {% endif %}
                                {% if task.resources_needed %}
                                <p><span class="font-bold text-gray-400 uppercase mr-1">Resources:</span>{{ task.resources_needed }}</p>
                                {% endif %}
                                {% if task.other_parties %}
                                <p><span class="font-bold text-gray-400 uppercase mr-1">External:</span>{{ task.other_parties }}</p>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Reschedule Reason -->
                            {% if task.status == 'Rescheduled' and task.reschedule_reason %}
                            <div class="mt-3 p-3 bg-orange-50 border-l-4 border-orange-400 rounded-r-lg">
                                <p class="text-[10px] font-bold text-orange-600 uppercase mb-0.5">Reschedule Reason</p>
                                <p class="text-xs text-orange-900 leading-relaxed">{{ task.reschedule_reason }}</p>
                            </div>
                            {% endif %}

                            <!-- Tags -->
                            {% if task.centre or task.collaborators.all %}
                            <div class="mt-3 flex flex-wrap gap-1.5">
                                {% if task.centre %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium bg-gray-100 text-gray-600">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                    {{ task.centre.name }}
                                </span>
                                {% endif %}
                                {% for col in task.collaborators.all %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium bg-purple-100 text-purple-700">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    {{ col.first_name }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if task.comments %}
                            <div class="mt-3 pt-2 border-t border-dashed border-gray-200 flex items-start gap-1.5 text-xs text-gray-500 italic">
                                <svg class="w-3 h-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                </svg>
                                <span>{{ task.comments|linebreaksbr }}</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Task Actions -->
                        <div class="flex flex-row md:flex-col items-center justify-end md:justify-start gap-1 p-3 md:p-2 md:border-l border-t md:border-t-0 border-gray-100 bg-gray-50/50 md:bg-transparent">
                            {% if task.can_comment %}
                            <button onclick="openCommentModal('{{ task.id }}')"
                                class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:bg-blue-100 hover:text-blue-600 transition-colors duration-150" title="Add Comment">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                </svg>
                            </button>
                            {% endif %}

                            {% if task.can_edit %}
                            <button onclick="openEditModal('{{ task.id }}')"
                                class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:bg-green-100 hover:text-green-600 transition-colors duration-150" title="Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            {% endif %}

                            {% if task.can_reschedule %}
                            <button onclick="openRescheduleModal('{{ task.id }}')"
                                class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:bg-orange-100 hover:text-orange-600 transition-colors duration-150" title="Reschedule">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </button>
                            {% endif %}

                            {% if task.can_change_status %}
                            <form method="post" action="{% url 'work_plan_task_status_update' task.id %}">
                                {% csrf_token %}
                                {% if task.status != 'Completed' %}
                                <button type="submit" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:bg-green-100 hover:text-green-600 transition-colors duration-150" title="Mark Done">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </button>
                                {% else %}
                                <button type="submit" class="w-8 h-8 flex items-center justify-center rounded-lg text-green-600 hover:bg-red-50 hover:text-red-600 transition-colors duration-150" title="Revert to Pending">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                </button>
                                {% endif %}
                            </form>
                            {% endif %}

                            {% if task.can_delete %}
                            <form method="post" action="{% url 'work_plan_task_delete' task.id %}" onsubmit="return confirm('Are you sure you want to delete this task?');">
                                {% csrf_token %}
                                <button type="submit" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:bg-red-100 hover:text-red-600 transition-colors duration-150" title="Delete">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            {% if not tasks %}
            <div class="text-center py-16 bg-white rounded-2xl border border-dashed border-gray-300">
                <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-gray-300">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                </div>
                <p class="text-gray-500 font-semibold mb-1">No tasks yet</p>
                <p class="text-sm text-gray-400">Tasks may be hidden or not created yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% include 'work_plan/modals.html' %}

<script>
function toggleLeaveMode() {
    const isChecked = document.getElementById('is_leave_checkbox').checked;
    const container = document.querySelector('.normal-fields');
    const inputs = container.querySelectorAll('input, select, textarea');

    if (isChecked) {
        container.classList.add('opacity-50', 'pointer-events-none');
        inputs.forEach(i => {
            if (i.id !== 'date_select') i.disabled = true;
            if (i.name === 'task_name') i.removeAttribute('required');
        });
    } else {
        container.classList.remove('opacity-50', 'pointer-events-none');
        inputs.forEach(i => {
            i.disabled = false;
            if (i.name === 'task_name') i.setAttribute('required', '');
        });
    }
}

document.getElementById('date_select')?.addEventListener('change', function () {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption && selectedOption.disabled) {
        alert("This day is marked as 'On Leave'. You cannot add regular tasks on leave days.");
        this.selectedIndex = 0;
    }
});

function openCommentModal(id) {
    document.getElementById('commentForm').action = `/it_operations/workplans/task/${id}/comment/`;
    document.getElementById('commentModal').classList.remove('hidden');
}

function openRescheduleModal(id) {
    document.getElementById('rescheduleForm').action = `/it_operations/workplans/task/${id}/reschedule/`;
    document.getElementById('rescheduleModal').classList.remove('hidden');
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('reschedule_date').setAttribute('min', today);
}

function openEditModal(id) {
    const modal = document.getElementById('editModal');
    const loader = document.getElementById('editLoader');
    modal.classList.remove('hidden');
    loader.classList.remove('hidden');
    document.getElementById('editForm').action = `/it_operations/workplans/task/${id}/edit/`;

    fetch("{% url 'get_task_details_json' 0 %}".replace('0', id))
        .then(response => {
            if (!response.ok) throw new Error('Failed');
            return response.json();
        })
        .then(data => {
            document.getElementById('edit_task_name').value = data.task_name;
            document.getElementById('edit_target').value = data.target || '';
            document.getElementById('edit_resources').value = data.resources_needed || '';
            document.getElementById('edit_other_parties').value = data.other_parties || '';
            document.getElementById('edit_is_leave').checked = data.is_leave;
            document.getElementById('edit_centre').value = data.centre || '';
            document.getElementById('edit_department').value = data.department || '';

            const collabSelect = document.getElementById('edit_collaborators');
            if (collabSelect) {
                Array.from(collabSelect.options).forEach(option => {
                    option.selected = data.collaborators.includes(parseInt(option.value));
                });
            }

            toggleEditLeave();
            loader.classList.add('hidden');
        })
        .catch(err => {
            console.error(err);
            alert("Could not load task details.");
            modal.classList.add('hidden');
            loader.classList.add('hidden');
        });
}

function toggleEditLeave() {
    const isChecked = document.getElementById('edit_is_leave').checked;
    const container = document.getElementById('edit_fields_container');
    if (isChecked) {
        container.classList.add('opacity-50', 'pointer-events-none');
    } else {
        container.classList.remove('opacity-50', 'pointer-events-none');
    }
}

document.addEventListener('DOMContentLoaded', function () {
    toggleLeaveMode();
});
</script>
{% endblock %}