{% extends 'dashboard.html' %}
{% block title %}Calendar - MOHI IT{% endblock %}

{% block content %}
<div class="container mx-auto p-4 lg:p-6 animate-fade-in">
    
    <!-- Server Messages -->
    {% if messages %}
    <div class="mb-6 space-y-2">
        {% for message in messages %}
        <div class="p-4 rounded-lg shadow-sm flex items-center gap-3
            {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200
            {% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200
            {% elif message.tags == 'info' %}bg-blue-100 text-blue-800 border border-blue-200
            {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-200
            {% else %}bg-gray-100 text-gray-800 border border-gray-200{% endif %}">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                {% if message.tags == 'success' %}
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                {% elif message.tags == 'error' %}
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                {% elif message.tags == 'warning' %}
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                {% else %}
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                {% endif %}
            </svg>
            <span class="font-medium">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-6">
        <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-6">
                <a href="{% url 'work_plan_list' %}?user_filter={{ target_user.id }}" class="text-gray-400 hover:text-primary transition" title="Back to Dashboard">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                </a>
                <div>
                    <h1 class="text-3xl font-extrabold text-primary uppercase tracking-wide">
                        {{ month_name }} <span class="text-gray-400 font-light">{{ year }}</span>
                    </h1>
                    {% if target_user != request.user %}
                    <div class="inline-flex items-center mt-1 px-2 py-0.5 rounded bg-blue-50 text-blue-700 text-xs font-bold">
                        Viewing: {{ target_user.get_full_name }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="flex flex-wrap gap-3 items-center justify-center">
                <div class="flex items-center bg-gray-100 rounded-lg p-1">
                    <a href="?year={{ prev_year }}&month={{ prev_month }}&user_filter={{ target_user.id }}" class="px-3 py-1.5 hover:bg-white hover:shadow rounded text-gray-600 font-bold text-sm transition">Prev</a>
                    <span class="px-2 text-gray-300">|</span>
                    <a href="?year={{ next_year }}&month={{ next_month }}&user_filter={{ target_user.id }}" class="px-3 py-1.5 hover:bg-white hover:shadow rounded text-gray-600 font-bold text-sm transition">Next</a>
                </div>

                <!-- Replace the existing report dropdown with this -->
<div class="relative">
    <button onclick="toggleReportMenu()" class="flex items-center px-4 py-2 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-700 shadow transition">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Download Report
    </button>
    <div id="reportMenu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl z-50 border border-gray-100 overflow-hidden">
        <div class="bg-gray-50 px-4 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider">Excel / CSV</div>
        <a href="{% url 'download_bulk_excel_report' %}?report_type=weekly&user_filter={{ target_user.id }}" class="block px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-accent transition">
            Current Week (Excel)
        </a>
        <a href="{% url 'download_bulk_excel_report' %}?report_type=monthly&year={{ year }}&month={{ month }}&user_filter={{ target_user.id }}" class="block px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-accent transition">
            Selected Month ({{ month_name }}) - Excel
        </a>
        <a href="{% url 'download_bulk_excel_report' %}?report_type=annual&year={{ year }}&user_filter={{ target_user.id }}" class="block px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-accent transition">
            Selected Year ({{ year }}) - Excel
        </a>

        <div class="border-t border-gray-200"></div>
        <div class="bg-gray-50 px-4 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider">PDF Report</div>
        <a href="{% url 'download_bulk_pdf_report' %}?report_type=weekly&user_filter={{ target_user.id }}" class="block px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-red-600 transition">
            Current Week (PDF)
        </a>
        <a href="{% url 'download_bulk_pdf_report' %}?report_type=monthly&year={{ year }}&month={{ month }}&user_filter={{ target_user.id }}" class="block px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-red-600 transition">
            Selected Month ({{ month_name }}) - PDF
        </a>
        <a href="{% url 'download_bulk_pdf_report' %}?report_type=annual&year={{ year }}&user_filter={{ target_user.id }}" class="block px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-red-600 transition">
            Selected Year ({{ year }}) - PDF
        </a>
    </div>
</div>
            </div>
        </div>
        
        <div class="mt-6 pt-4 border-t border-gray-100 flex flex-wrap gap-2 justify-center lg:justify-start">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mr-2 self-center">Filter:</span>
            <button onclick="filterCalendar('all')" class="filter-btn active px-3 py-1 rounded-full text-xs font-bold bg-gray-800 text-white transition shadow">All</button>
            <button onclick="filterCalendar('active')" class="filter-btn px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-800 hover:bg-blue-200 transition">Active</button>
            <button onclick="filterCalendar('collab')" class="filter-btn px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-800 hover:bg-purple-200 transition">Collab</button>
            <button onclick="filterCalendar('completed')" class="filter-btn px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 hover:bg-green-200 transition">Completed</button>
            <button onclick="filterCalendar('not_done')" class="filter-btn px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800 hover:bg-red-200 transition">Not Done</button>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200 select-none">
        <div class="grid grid-cols-7 border-b border-gray-200 bg-primary text-white">
            <div class="py-3 text-center text-xs font-bold uppercase tracking-widest">Mon</div>
            <div class="py-3 text-center text-xs font-bold uppercase tracking-widest">Tue</div>
            <div class="py-3 text-center text-xs font-bold uppercase tracking-widest">Wed</div>
            <div class="py-3 text-center text-xs font-bold uppercase tracking-widest">Thu</div>
            <div class="py-3 text-center text-xs font-bold uppercase tracking-widest">Fri</div>
            <div class="py-3 text-center text-xs font-bold uppercase tracking-widest">Sat</div>
            <div class="py-3 text-center text-xs font-bold uppercase tracking-widest bg-gray-800">Sun</div>
        </div>

        <div class="bg-gray-200 gap-px">
            {% for week in calendar_grid %}
            <div class="grid grid-cols-7 gap-px">
                {% for day in week %}
                <div class="min-h-[140px] p-2 relative flex flex-col group transition duration-200 {{ day.css_class }} hover:bg-white overflow-hidden">
                    
                    <!-- Full Yellow Block for On Leave Days -->
                    {% if day.has_leave_task %}
                    <div class="absolute inset-0 bg-yellow-200 z-10 pointer-events-none"></div>
                    {% endif %}

                    <!-- Light-Blue Overlay for All-Pending Days -->
                    {% if day.all_pending %}
                    <div class="absolute inset-0 bg-blue-100 opacity-70 z-10 pointer-events-none"></div>
                    {% endif %}

                    <div class="flex justify-between items-start mb-1 z-30 relative">
                        <span class="text-sm font-bold w-7 h-7 flex items-center justify-center rounded-full
                            {% if day.is_today %}bg-accent text-white shadow-lg ring-2 ring-blue-200
                            {% elif day.is_holiday %}text-red-500 bg-red-50
                            {% else %}text-gray-500{% endif %}">
                            {{ day.day_num }}
                        </span>
                        {% if day.is_holiday %}
                        <span class="text-[8px] uppercase font-black text-red-400 tracking-tight">Holiday</span>
                        {% endif %}
                    </div>

                    <div class="space-y-1 flex-grow overflow-y-auto max-h-[90px] custom-scrollbar z-30 relative">
                        {% for event in day.events %}
                        <div onclick="openViewModal('{{ event.id }}', '{{ event.work_plan_id }}')" 
                             class="event-item task-{{ event.status_code }} block text-[10px] px-2 py-1 rounded border-l-2 truncate cursor-pointer hover:opacity-80 transition shadow-sm {{ event.color }} font-semibold z-30"
                             title="{{ event.title }}">
                            {{ event.title }}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Add Button - Only on valid workdays -->
                    {% if day.can_add_task and not day.has_leave_task and not day.is_holiday and day.date.weekday != 6 %}
                    <button onclick="openAddTaskModal('{{ day.date|date:'Y-m-d' }}')" 
                            class="absolute bottom-2 right-2 w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-600 rounded-full shadow-lg transition-all duration-300 opacity-0 group-hover:opacity-100 hover:bg-green-500 hover:text-white hover:shadow-2xl hover:scale-125 z-40"
                            title="Add Task">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                        </svg>
                    </button>
                    {% endif %}

                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- View Task Modal -->
<div id="viewTaskModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4" onclick="if(event.target === this) closeViewModal()">
    <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden animate-scale-in">
        <div class="bg-primary p-4 flex justify-between items-center">
            <h3 class="text-lg font-bold text-white">Task Details</h3>
            <button onclick="closeViewModal()" class="text-white hover:text-gray-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>
        
        <div class="p-6 relative">
            <div id="viewLoader" class="absolute inset-0 bg-white flex items-center justify-center z-10 rounded-2xl">
                <svg class="animate-spin h-8 w-8 text-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            </div>

            <div class="space-y-4">
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase">Task</p>
                    <p id="view_task_name" class="text-lg font-bold text-gray-800"></p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase">Status</p>
                        <span id="view_status" class="inline-block px-2 py-1 text-xs font-bold rounded bg-gray-100 text-gray-800 mt-1"></span>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase">Date</p>
                        <p id="view_date" class="text-sm font-medium text-gray-700 mt-1"></p>
                    </div>
                </div>
                <div>
                     <p class="text-xs font-bold text-gray-400 uppercase">Target/Outcome</p>
                     <p id="view_target" class="text-sm text-gray-600 bg-gray-50 p-2 rounded mt-1"></p>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-100">
                <a id="view_full_details_link" href="#" class="block w-full text-center px-4 py-3 bg-accent text-white rounded-xl font-bold hover:bg-blue-600 shadow-lg transition">
                    Go to Weekly Plan
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Responsive Add Task Modal -->
<div id="addTaskModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4" onclick="if(event.target === this) closeAddTaskModal()">
    <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden animate-scale-in max-h-[95vh] flex flex-col">
        <div class="bg-primary p-4 flex justify-between items-center">
            <h3 class="text-xl font-bold text-white">Add New Task</h3>
            <button onclick="closeAddTaskModal()" class="text-white hover:text-gray-300 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="p-6 overflow-y-auto flex-grow">
            <form method="post" action="{% url 'work_plan_create_task_from_calendar' %}">
                {% csrf_token %}
                <input type="hidden" name="date" id="addTaskDate">

                <div class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 flex items-center gap-4">
                    <input type="checkbox" name="is_leave" id="add_is_leave" onchange="toggleAddLeave()" class="w-6 h-6 text-yellow-600 rounded focus:ring-yellow-500 cursor-pointer">
                    <label for="add_is_leave" class="text-lg font-bold text-yellow-800 cursor-pointer">Mark as "On Leave"</label>
                </div>

                <div id="add_fields_container" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-600 uppercase mb-2">Task Name <span class="text-red-500">*</span></label>
                        <input type="text" name="task_name" required placeholder="e.g., Configure new firewall" class="w-full rounded-lg border-gray-300 bg-gray-50 px-4 py-3 text-base focus:ring-2 focus:ring-accent outline-none">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-600 uppercase mb-2">Centre</label>
                            <select name="centre" class="w-full rounded-lg border-gray-300 bg-gray-50 px-4 py-3 text-base">
                                <option value="">- None -</option>
                                {% for centre in centres %}
                                <option value="{{ centre.id }}">{{ centre.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-600 uppercase mb-2">Department</label>
                            <select name="department" class="w-full rounded-lg border-gray-300 bg-gray-50 px-4 py-3 text-base">
                                <option value="">- None -</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-600 uppercase mb-2">Collaborators</label>
                        <select name="collaborators" multiple class="w-full rounded-lg border-gray-300 bg-gray-50 px-4 py-3 text-base h-32 custom-scrollbar">
                            {% for user in potential_collaborators %}
                            <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-400 mt-2">Hold Ctrl/Cmd to select multiple</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-600 uppercase mb-2">Resources Needed</label>
                        <textarea name="resources_needed" rows="3" placeholder="List required resources..." class="w-full rounded-lg border-gray-300 bg-gray-50 px-4 py-3 text-base focus:ring-2 focus:ring-accent outline-none"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-600 uppercase mb-2">Target Outcome</label>
                        <textarea name="target" rows="3" placeholder="Expected result or deliverable..." class="w-full rounded-lg border-gray-300 bg-gray-50 px-4 py-3 text-base focus:ring-2 focus:ring-accent outline-none"></textarea>
                    </div>

                    <div class="pt-6">
                        <button type="submit" class="w-full py-4 bg-primary text-white rounded-xl font-bold text-xl shadow-lg hover:bg-opacity-90 hover:shadow-xl transition transform hover:-translate-y-1">
                            Add Task to Plan
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Filter Logic
    function filterCalendar(type) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('bg-gray-800', 'text-white');
            btn.style.opacity = '0.6';
        });
        
        event.target.style.opacity = '1';
        event.target.classList.add('bg-gray-800', 'text-white');

        const items = document.querySelectorAll('.event-item');
        items.forEach(item => {
            item.style.display = (type === 'all' || item.classList.contains(`task-${type}`)) ? 'block' : 'none';
        });
    }

    function toggleReportMenu() {
        document.getElementById('reportMenu').classList.toggle('hidden');
    }

    function openViewModal(taskId, workPlanId) {
        document.getElementById('viewTaskModal').classList.remove('hidden');
        document.getElementById('viewLoader').classList.remove('hidden');
        
        const url = "{% url 'get_task_details_json' 0 %}".replace('0', taskId);

        fetch(url)
            .then(res => res.json())
            .then(data => {
                document.getElementById('view_task_name').innerText = data.task_name;
                document.getElementById('view_status').innerText = data.status;
                document.getElementById('view_date').innerText = data.date;
                document.getElementById('view_target').innerText = data.target || 'N/A';
                
                document.getElementById('view_full_details_link').href = "{% url 'work_plan_detail' 0 %}".replace('0', workPlanId);
                
                document.getElementById('viewLoader').classList.add('hidden');
            })
            .catch(err => {
                alert("Error loading task details");
                closeViewModal();
            });
    }

    function closeViewModal() {
        document.getElementById('viewTaskModal').classList.add('hidden');
    }

    function openAddTaskModal(dateStr) {
        document.getElementById('addTaskDate').value = dateStr;
        document.getElementById('addTaskModal').classList.remove('hidden');
        document.getElementById('add_is_leave').checked = false;
        toggleAddLeave();
    }

    function closeAddTaskModal() {
        document.getElementById('addTaskModal').classList.add('hidden');
    }

    function toggleAddLeave() {
        const checked = document.getElementById('add_is_leave').checked;
        const container = document.getElementById('add_fields_container');
        const taskName = document.querySelector('input[name="task_name"]');
        
        if (checked) {
            container.classList.add('opacity-50', 'pointer-events-none');
            taskName.removeAttribute('required');
        } else {
            container.classList.remove('opacity-50', 'pointer-events-none');
            taskName.setAttribute('required', '');
        }
    }
</script>
{% endblock %}