{% extends 'dashboard.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto p-4">
    <h2 class="text-3xl font-bold mb-6 text-primary animate-fade-in">Dashboard Overview</h2>

    <!-- Messages -->
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="bg-{% if message.tags == 'error' %}red{% else %}green{% endif %}-100 border border-{% if message.tags == 'error' %}red{% else %}green{% endif %}-400 text-{% if message.tags == 'error' %}red{% else %}green{% endif %}-700 px-6 py-4 rounded-lg relative" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Key Metrics Cards with Detailed Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 animate-slide-up">
        <!-- Total Devices Card -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-accent transition duration-300 hover:shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Devices</p>
                    <p class="text-3xl font-bold text-accent">{{ total_devices }}</p>
                    <p class="text-xs text-gray-500 mt-1">Approved: {{ approved_devices }} | Disposed: {{ disposed_devices }} | Recent: {{ recent_devices_count }}</p>
                </div>
                <svg class="w-12 h-12 text-accent opacity-20" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                </svg>
            </div>
        </div>

        <!-- Pending/Approved Card -->
        {% if user.is_superuser %}
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-error transition duration-300 hover:shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Pending Approvals</p>
                    <p class="text-3xl font-bold text-error">{{ pending_approvals }}</p>
                    <p class="text-xs text-gray-500 mt-1">Pending Updates: {{ pending_updates }}</p>
                </div>
                <svg class="w-12 h-12 text-error opacity-20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
        {% else %}
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500 transition duration-300 hover:shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Approved Devices</p>
                    <p class="text-3xl font-bold text-green-600">{{ approved_devices }}</p>
                    <p class="text-xs text-gray-500 mt-1">Active inventory</p>
                </div>
                <svg class="w-12 h-12 text-green-500 opacity-20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
        {% endif %}

        <!-- PPM Tasks Card with Detailed Stats -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-secondary transition duration-300 hover:shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total PPM Tasks</p>
                    <p class="text-3xl font-bold text-secondary">{{ total_ppm_tasks }}</p>
                    <p class="text-xs text-gray-500 mt-1">Completed: {{ completed_ppm_tasks }} ({{ ppm_completion_rate }}%) | Incomplete: {{ incomplete_ppm_tasks }} | Avg Time: {{ avg_completion_time|default:"N/A" }} days</p>
                </div>
                <svg class="w-12 h-12 text-secondary opacity-20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>

        <!-- Overdue PPM Card with Detailed Stats -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500 transition duration-300 hover:shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Overdue PPM Tasks</p>
                    <p class="text-3xl font-bold text-yellow-600">{{ overdue_ppm_tasks }}</p>
                    <p class="text-xs text-gray-500 mt-1">Due Soon: {{ tasks_due_soon }}</p>
                </div>
                <svg class="w-12 h-12 text-yellow-500 opacity-20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
    </div>

    {% if user.is_superuser %}
    <!-- User & System Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 animate-slide-up">
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500 transition duration-300 hover:shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Users</p>
                    <p class="text-3xl font-bold text-blue-600">{{ total_users }}</p>
                    <p class="text-xs text-gray-500 mt-1">Active: {{ active_users }}</p>
                </div>
                <svg class="w-12 h-12 text-blue-500 opacity-20" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2a4 4 0 00-4 4 4 4 0 004 4 4 4 0 004-4 4 4 0 00-4-4zm0 10c-2.67 0-8 1.33-8 4v2h16v-2c0-2.67-5.33-4-8-4z"></path>
                </svg>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500 transition duration-300 hover:shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Centres</p>
                    <p class="text-3xl font-bold text-purple-600">{{ total_centres }}</p>
                    <p class="text-xs text-gray-500 mt-1">Managed centres</p>
                </div>
                <svg class="w-12 h-12 text-purple-500 opacity-20" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2L2 7v6l8 5 8-5V7l-8-5zm0 2.727L15.273 8 10 11.273 4.727 8 10 4.727zM4 9.727l5.273 3.273V16.273L4 13V9.727zm6 6.546V13l5.273-3.273V13L10 16.273z"></path>
                </svg>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Charts Row - All charts displayed directly -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 animate-fade-in">
        <!-- Device Status Chart -->
        {% if device_status_breakdown %}
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">Device Status Distribution</h3>
            <div style="position: relative; height: 250px;">
                <canvas id="deviceStatusChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Device Condition Chart -->
        {% if device_condition_breakdown %}
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">Device Condition Distribution</h3>
            <div style="position: relative; height: 250px;">
                <canvas id="deviceConditionChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- PPM Task Status Chart -->
        {% if total_ppm_tasks > 0 %}
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">PPM Task Status</h3>
            <div style="position: relative; height: 250px;">
                <canvas id="ppmStatusChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- PPM Tasks by Period Chart -->
        {% if ppm_tasks_by_period %}
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">PPM Tasks by Period</h3>
            <div style="position: relative; height: 250px;">
                <canvas id="ppmPeriodChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Monthly Trends Chart (Full Width) -->
        <div class="bg-white p-6 rounded-xl shadow-lg col-span-1 md:col-span-2 lg:col-span-3">
            <h3 class="text-lg font-semibold mb-4 text-primary">Monthly Trends (Last 6 Months)</h3>
            <div style="position: relative; height: 300px;">
                <canvas id="monthlyTrendsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Distribution Sections -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 animate-slide-up">
        <!-- Devices by Centre -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">Devices by Centre (Top 10)</h3>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for item in devices_by_centre %}
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded transition duration-200">
                    <span class="text-sm text-gray-700">{{ item.centre__name|default:"Unassigned" }}</span>
                    <div class="flex items-center">
                        <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-accent h-2 rounded-full" style="width: {% widthratio item.count total_devices 100 %}%"></div>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">{{ item.count }}</span>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">No data available</p>
                {% endfor %}
            </div>
        </div>

        <!-- Devices by Hardware -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">Devices by Hardware Type (Top 10)</h3>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for item in devices_by_hardware %}
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded transition duration-200">
                    <span class="text-sm text-gray-700">{{ item.hardware|default:"Unknown" }}</span>
                    <div class="flex items-center">
                        <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-secondary h-2 rounded-full" style="width: {% widthratio item.count total_devices 100 %}%"></div>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">{{ item.count }}</span>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">No data available</p>
                {% endfor %}
            </div>
        </div>

        <!-- PPM Tasks by Activity -->
        {% if total_ppm_tasks > 0 %}
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">PPM Tasks by Activity (Top 10)</h3>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for item in ppm_tasks_by_activity %}
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded transition duration-200">
                    <span class="text-sm text-gray-700">{{ item.activities__name|default:"Unspecified" }}</span>
                    <span class="text-sm font-semibold text-accent">{{ item.count }}</span>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">No activities recorded</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- PPM by Centre and Users by Centre -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 animate-slide-up">
        <!-- PPM by Centre -->
        {% if total_ppm_tasks > 0 %}
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">PPM Tasks by Centre (Top 10)</h3>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for item in ppm_by_centre %}
                <div class="p-3 bg-gray-50 rounded-lg transition duration-200 hover:bg-gray-100">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700">{{ item.device__centre__name|default:"Unassigned" }}</span>
                        <span class="text-xs text-gray-500">{{ item.total }} tasks</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: {% if item.total > 0 %}{% widthratio item.completed item.total 100 %}{% else %}0{% endif %}%"></div>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">{{ item.completed }} completed ({% if item.total > 0 %}{% widthratio item.completed item.total 100 %}{% else %}0{% endif %}%)</p>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">No data available</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Users by Centre (Superuser only) -->
        {% if user.is_superuser and users_by_centre %}
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">Users by Centre (Top 10)</h3>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for item in users_by_centre %}
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded transition duration-200">
                    <span class="text-sm text-gray-700">{{ item.centre__name|default:"Unassigned" }}</span>
                    <div class="flex items-center">
                        <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-purple-500 h-2 rounded-full" style="width: {% widthratio item.count total_users 100 %}%"></div>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">{{ item.count }}</span>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">No data available</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Recent Activity Sections -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 animate-fade-in">
        <!-- Recent Devices Table -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">Recent Devices (Last 30 days: {{ recent_devices_count }})</h3>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial Number</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hardware</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for device in recent_devices %}
                        <tr class="hover:bg-gray-50 transition duration-200">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <a href="{% url 'device_history' device.id %}" class="text-accent hover:underline">
                                    {{ device.serial_number|default:"N/A" }}
                                </a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ device.hardware|default:"N/A" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ device.date|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-6 py-4 text-center text-gray-500 text-sm">No recent devices</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent PPM Completions Table -->
        {% if recent_ppm_completions %}
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-primary">Recent PPM Completions</h3>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device SN</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for task in recent_ppm_completions %}
                        <tr class="hover:bg-gray-50 transition duration-200">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">{{ task.device.serial_number|default:"N/A" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">{{ task.period.name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">{{ task.completed_date|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-6 py-4 text-center text-gray-500 text-sm">No recent completions</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Recent Notifications -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-primary">Recent Notifications</h3>
                {% if unread_count > 0 %}
                <span class="bg-error text-white text-xs font-bold px-2 py-1 rounded-full">{{ unread_count }}</span>
                {% endif %}
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for notification in notifications %}
                <div class="p-3 {% if not notification.is_read %}bg-blue-50 border-l-4 border-accent{% else %}bg-gray-50{% endif %} rounded transition duration-200 hover:shadow-md">
                    <p class="text-sm text-gray-700">{{ notification.message }}</p>
                    <p class="text-xs text-gray-500 mt-1">{{ notification.created_at|date:"M d, Y H:i" }}</p>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">No notifications</p>
                {% endfor %}
            </div>
            <a href="{% url 'notifications_view' %}" class="text-accent hover:underline text-sm mt-3 inline-block">View All Notifications</a>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white p-6 rounded-xl shadow-lg animate-slide-up">
        <h3 class="text-lg font-semibold mb-4 text-primary">Quick Actions</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <a href="{% url 'import_add' %}" class="bg-accent text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"></path>
                </svg>
                Add Device
            </a>
            <a href="{% url 'display_approved_imports' %}" class="bg-secondary text-white px-4 py-3 rounded-lg hover:bg-orange-700 transition duration-300 flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                </svg>
                View Devices
            </a>
            {% if user.is_superuser and pending_approvals > 0 %}
            <a href="{% url 'display_unapproved_imports' %}" class="bg-error text-white px-4 py-3 rounded-lg hover:bg-red-700 transition duration-300 flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                Review Approvals ({{ pending_approvals }})
            </a>
            {% endif %}
            <a href="{% url 'ppm_device_list' %}" class="bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition duration-300 flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
                PPM Devices
            </a>
            {% if total_ppm_tasks > 0 %}
            <a href="{% url 'ppm_report' %}" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path>
                </svg>
                PPM Reports
            </a>
            {% endif %}
            <a href="{% url 'ppm_history' %}" class="bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                PPM History
            </a>
            {% if user.is_superuser %}
            <a href="{% url 'upload_csv' %}" class="bg-teal-600 text-white px-4 py-3 rounded-lg hover:bg-teal-700 transition duration-300 flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                Upload CSV
            </a>
            <a href="{% url 'manage_activities' %}" class="bg-pink-600 text-white px-4 py-3 rounded-lg hover:bg-pink-700 transition duration-300 flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                </svg>
                Manage Activities
            </a>
            {% endif %}
            <a href="{% url 'export_to_pdf' %}" class="bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition duration-300 flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path>
                </svg>
                Export Devices (PDF)
            </a>
        </div>
    </div>
</div>

<!-- Chart.js Script with Debugging -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chart.js loaded');
    // Device Status Chart
    {% if device_status_breakdown %}
    console.log('Rendering Device Status Chart');
    const deviceStatusCtx = document.getElementById('deviceStatusChart').getContext('2d');
    new Chart(deviceStatusCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for item in device_status_breakdown %}'{{ item.status|default:"Unknown" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in device_status_breakdown %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#288CC8', '#C86450', '#143C50', '#A0A0A0', '#DCDCF0', '#10B981', '#F59E0B', '#EF4444'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% else %}
    console.log('No data for Device Status Chart');
    {% endif %}

    // Device Condition Chart
    {% if device_condition_breakdown %}
    console.log('Rendering Device Condition Chart');
    const deviceConditionCtx = document.getElementById('deviceConditionChart').getContext('2d');
    new Chart(deviceConditionCtx, {
        type: 'pie',
        data: {
            labels: [{% for item in device_condition_breakdown %}'{{ item.device_condition|default:"Unknown" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in device_condition_breakdown %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#A855F7'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% else %}
    console.log('No data for Device Condition Chart');
    {% endif %}

    // PPM Status Chart
    {% if total_ppm_tasks > 0 %}
    console.log('Rendering PPM Status Chart');
    const ppmStatusCtx = document.getElementById('ppmStatusChart').getContext('2d');
    new Chart(ppmStatusCtx, {
        type: 'bar',
        data: {
            labels: ['Completed', 'Incomplete', 'Overdue'],
            datasets: [{
                label: 'PPM Tasks',
                data: [{{ completed_ppm_tasks|default:0 }}, {{ incomplete_ppm_tasks|default:0 }}, {{ overdue_ppm_tasks|default:0 }}],
                backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
    {% else %}
    console.log('No data for PPM Status Chart');
    {% endif %}

    // PPM by Period Chart
    {% if ppm_tasks_by_period %}
    console.log('Rendering PPM by Period Chart');
    const ppmPeriodCtx = document.getElementById('ppmPeriodChart').getContext('2d');
    new Chart(ppmPeriodCtx, {
        type: 'bar',
        data: {
            labels: [{% for item in ppm_tasks_by_period %}'{{ item.period__name|default:"Unknown" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [
                { label: 'Completed', data: [{% for item in ppm_tasks_by_period %}{{ item.completed }}{% if not forloop.last %}, {% endif %}{% endfor %}], backgroundColor: '#10B981' },
                { label: 'Total', data: [{% for item in ppm_tasks_by_period %}{{ item.total }}{% if not forloop.last %}, {% endif %}{% endfor %}], backgroundColor: '#288CC8' }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, stacked: true }, x: { stacked: true } }
        }
    });
    {% else %}
    console.log('No data for PPM by Period Chart');
    {% endif %}

    // Monthly Trends Chart
    {% if devices_monthly %}
    console.log('Rendering Monthly Trends Chart');
    const monthlyTrendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
    new Chart(monthlyTrendsCtx, {
        type: 'line',
        data: {
            labels: [{% for item in devices_monthly %}'{{ item.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [
                { label: 'Devices Added', data: [{% for item in devices_monthly %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}], borderColor: '#288CC8', fill: false },
                { label: 'PPM Completed', data: [{% for item in ppm_completed_monthly %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}], borderColor: '#10B981', fill: false }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
    {% else %}
    console.log('No data for Monthly Trends Chart');
    {% endif %}
});
</script>

<style>
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-up {
        animation: slideUp 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .animate-fade-in {
        animation: fadeIn 1s ease-in;
    }
</style>
{% endblock %}