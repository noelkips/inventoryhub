{% extends 'dashboard.html' %}
{% load static %}
{% load custom_filters %} {# Required for get_category_value filter #}

{% block content %}
<div class="container mx-auto p-4 lg:p-6">
    <div class="mb-8 animate-fade-in">
        <h1 class="text-4xl font-bold text-primary mb-2">
            Welcome back, {{ user.username }}! üëã
        </h1>
        <p class="text-gray-600">Here's what's happening with your IT inventory today.</p>
    </div>

    {% if messages %}
        <div class="mb-6 animate-slide-down">
            {% for message in messages %}
                <div class="bg-{% if message.tags == 'error' %}red{% else %}green{% endif %}-100 border-l-4 border-{% if message.tags == 'error' %}red{% else %}green{% endif %}-500 text-{% if message.tags == 'error' %}red{% else %}green{% endif %}-700 px-6 py-4 rounded-lg shadow-md mb-4 flex items-center" role="alert">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        {% if message.tags == 'error' %}
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        {% else %}
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        {% endif %}
                    </svg>
                    <span>{{ message }}</span>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="bg-blue-900 p-6 rounded-2xl shadow-xl mb-8 animate-slide-up">
        <h3 class="text-white text-lg font-semibold mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"></path>
            </svg>
            Quick Actions
        </h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
            <a href="{% url 'import_add' %}" class="group bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform">
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"></path>
                </svg>
                <span class="text-sm font-medium">Add Device</span>
            </a>
            
            <a href="{% url 'display_approved_imports' %}" class="group bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform">
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium">View All Devices</span>
            </a>
            
            {% if user.is_superuser and pending_approvals > 0 %}
            <a href="{% url 'display_unapproved_imports' %}" class="group bg-error bg-opacity-90 backdrop-blur-sm hover:bg-opacity-100 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform relative">
                <span class="absolute -top-2 -right-2 bg-white text-error text-xs font-bold px-2 py-1 rounded-full">{{ pending_approvals }}</span>
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium">Approvals</span>
            </a>
            {% endif %}
            
            <a href="{% url 'ppm_device_list' %}" class="group bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform">
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium">PPM Tasks</span>
            </a>
            
            <a href="{% url 'ppm_report' %}" class="group bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform">
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium">See PPM Reports</span>
            </a>
            
            <a href="{% url 'ppm_history' %}" class="group bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform">
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium">See PPM History</span>
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-accent transform hover:-translate-y-1 animate-scale-in">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Total Devices</p>
                    <a href="{% url 'filtered_list' 'devices' %}?clear=true" class="text-4xl font-bold text-accent mb-2 block hover:underline">{{ total_devices }}</a>
                    <div class="flex items-center space-x-4 text-xs text-gray-600">
                        <a href="{% url 'filtered_list' 'devices' %}" class="flex items-center hover:underline">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                            Approved: {{ approved_devices }}
                        </a>
                        <a href="{% url 'filtered_list' 'devices' %}?is_disposed=True" class="flex items-center hover:underline">
                            <span class="w-2 h-2 bg-gray-400 rounded-full mr-1"></span>
                            Disposed: {{ disposed_devices }}
                        </a>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">+{{ recent_devices_count }} this month</p>
                </div>
                <div class="bg-accent bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-accent" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                    </svg>
                </div>
            </div>
        </div>

        {% if user.is_superuser %}
        <div class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-error transform hover:-translate-y-1 animate-scale-in" style="animation-delay: 0.1s;">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Pending Action</p>
                    <a href="{% url 'display_unapproved_imports' %}" class="text-4xl font-bold text-error mb-2 block hover:underline">{{ pending_approvals }}</a>
                    <div class="text-xs text-gray-600">
                        <p><a href="{% url 'display_unapproved_imports' %}" class="hover:underline">Device Approvals: {{ pending_approvals }}</a></p>
                        <p><a href="{% url 'filtered_list' 'pending_updates' %}" class="hover:underline">Pending Updates: {{ pending_updates }}</a></p>
                    </div>
                </div>
                <div class="bg-error bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-error" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
        {% else %}
        <div class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-green-500 transform hover:-translate-y-1 animate-scale-in" style="animation-delay: 0.1s;">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Approved Devices</p>
                    <a href="{% url 'filtered_list' 'devices' %}" class="text-4xl font-bold text-green-600 mb-2 block hover:underline">{{ approved_devices }}</a>
                    <p class="text-xs text-gray-600">Active in inventory</p>
                </div>
                <div class="bg-green-500 bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-secondary transform hover:-translate-y-1 animate-scale-in" style="animation-delay: 0.2s;">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">PPM Tasks</p>
                    <a href="{% url 'filtered_list' 'ppm' %}?period_id={{ period_id }}" class="text-4xl font-bold text-secondary mb-2 block hover:underline">{{ total_ppm_tasks }}</a>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="bg-secondary rounded-full h-2 transition-all duration-500" style="width: {{ ppm_completion_rate }}%"></div>
                    </div>
                    <p class="text-xs text-gray-600">{{ ppm_completion_rate }}% completed ({{ devices_with_ppm }}/{{ approved_devices }})</p>
                </div>
                <div class="bg-secondary bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-secondary" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-yellow-500 transform hover:-translate-y-1 animate-scale-in" style="animation-delay: 0.3s;">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Overdue Tasks</p>
                    <a href="{% url 'filtered_list' 'ppm' %}?ppm_status=overdue" class="text-4xl font-bold text-yellow-600 mb-2 block hover:underline">{{ overdue_ppm_tasks }}</a>
                    <p class="text-xs text-gray-600"><a href="{% url 'filtered_list' 'ppm' %}?ppm_status=due_soon" class="hover:underline">Due soon: {{ tasks_due_soon }}</a></p>
                    {% if avg_completion_time %}
                    <p class="text-xs text-gray-500 mt-1">Avg time: {{ avg_completion_time }} days</p>
                    {% endif %}
                </div>
                <div class="bg-yellow-500 bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    {% if user.is_superuser %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <a href="{% url 'manage_users' %}" class="block">
            <div class="group bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl shadow-lg text-white transform hover:-translate-y-1 transition-all duration-300 animate-scale-in" style="animation-delay: 0.4s;">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-blue-100 text-sm font-medium uppercase tracking-wide mb-1">Total Users</p>
                        <p class="text-4xl font-bold mb-1">{{ total_users }}</p>
                        <p class="text-blue-100 text-xs">Active: {{ active_users }}</p>
                    </div>
                    <svg class="w-12 h-12 text-white opacity-30" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                </div>
            </div>
        </a>

        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl shadow-lg text-white transform hover:-translate-y-1 transition-all duration-300 animate-scale-in" style="animation-delay: 0.5s;">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-purple-100 text-sm font-medium uppercase tracking-wide mb-1">Total Centres</p>
                    <p class="text-4xl font-bold mb-1">{{ total_centres }}</p>
                    <p class="text-purple-100 text-xs">Managed locations</p>
                </div>
                <svg class="w-12 h-12 text-white opacity-30" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        {% if device_status_breakdown %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-primary">Device Status</h3>
                <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Live</span>
            </div>
            <div class="relative" style="height: 280px;">
                <canvas id="deviceStatusChart" class="cursor-pointer" 
                        data-filter-url="{% url 'filtered_list' 'devices' %}" 
                        data-filter-param="status"></canvas>
            </div>
        </div>
        {% endif %}

        {% if device_condition_breakdown %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-primary">Device Condition</h3>
                <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Live</span>
            </div>
            <div class="relative" style="height: 280px;">
                <canvas id="deviceConditionChart" class="cursor-pointer"
                        data-filter-url="{% url 'filtered_list' 'devices' %}"
                        data-filter-param="device_condition"></canvas>
            </div>
        </div>
        {% endif %}

        {% if ppm_status_labels %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in" style="animation-delay: 0.2s;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-primary">PPM Status</h3>
                <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Live</span>
            </div>
            <div class="relative" style="height: 280px;">
                <canvas id="ppmStatusChart" class="cursor-pointer"
                        data-filter-url="{% url 'filtered_list' 'ppm' %}"
                        data-filter-param="ppm_status"></canvas>
            </div>
        </div>
        {% endif %}
    </div>

    {% if devices_monthly %}
    <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 mb-8 animate-fade-in">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-primary">Activity Trends</h3>
            <div class="flex items-center space-x-4 text-sm">
                <span class="flex items-center"><span class="w-3 h-3 bg-accent rounded-full mr-2"></span>Devices Added</span>
                <span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>PPM Completed</span>
            </div>
        </div>
        <div class="relative" style="height: 350px;">
            <canvas id="monthlyTrendsChart"></canvas>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-slide-up">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-accent" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"></path>
                </svg>
                Top Centres
            </h3>
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                {% for item in devices_by_centre %}
                <a href="{% url 'filtered_list' 'devices' %}?centre_id={{ item.centre_id }}" class="block group p-3 bg-gray-50 hover:bg-gradient-to-r hover:from-accent hover:to-blue-500 rounded-xl transition-all duration-300 cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 group-hover:text-white transition-colors">{{ item.centre__name|default:"Unassigned" }}</span>
                        <span class="text-sm font-bold text-accent group-hover:text-white transition-colors">{{ item.count }}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div class="bg-accent group-hover:bg-white h-2 rounded-full transition-all duration-500" style="width: {% widthratio item.count total_devices 100 %}%"></div>
                    </div>
                </a>
                {% empty %}
                <p class="text-gray-500 text-sm text-center py-4">No data available</p>
                {% endfor %}
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-slide-up" style="animation-delay: 0.1s;">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                </svg>
                Device Categories
            </h3>
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                {% for item in devices_by_category %}
                <a href="{% url 'filtered_list' 'devices' %}?category={{ item.category|get_category_value }}" class="block group p-3 bg-gray-50 hover:bg-gradient-to-r hover:from-orange-400 hover:to-orange-500 rounded-xl transition-all duration-300 cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 group-hover:text-white transition-colors">{{ item.category }}</span>
                        <span class="text-sm font-bold text-orange-600 group-hover:text-white transition-colors">{{ item.count }}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div class="bg-orange-500 group-hover:bg-white h-2 rounded-full transition-all duration-500" style="width: {% widthratio item.count approved_devices 100 %}%"></div>
                    </div>
                </a>
                {% empty %}
                <p class="text-gray-500 text-sm text-center py-4">No categorized devices</p>
                {% endfor %}
            </div>
        </div>

        {% if ppm_tasks_by_activity %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-slide-up" style="animation-delay: 0.2s;">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                </svg>
                Top Activities {% if period_name %} ({{ period_name }}){% endif %}
            </h3>
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                {% for item in ppm_tasks_by_activity %}
                <a href="{% url 'filtered_list' 'ppm' %}?activity={{ item.activities__name|urlencode }}&period_id={{ period_id }}" class="block group p-3 bg-gray-50 hover:bg-gradient-to-r hover:from-purple-500 hover:to-purple-600 rounded-xl transition-all duration-300 cursor-pointer">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700 group-hover:text-white transition-colors flex-1">{{ item.activities__name|default:"Unspecified" }}</span>
                        <span class="text-sm font-bold text-purple-600 group-hover:text-white transition-colors ml-2">{{ item.count }}</span>
                    </div>
                </a>
                {% empty %}
                <p class="text-gray-500 text-sm text-center py-4">No activities recorded</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        {% if ppm_by_centre %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-slide-up">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
                PPM by Centre {% if period_name %} ({{ period_name }}){% endif %}
            </h3>
            <div class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                {% for item in ppm_by_centre %}
                <a href="{% url 'filtered_list' 'ppm' %}?centre_id={{ item.centre_id }}&period_id={{ period_id }}" class="block p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl hover:from-green-50 hover:to-green-100 transition-all duration-300 border-l-4 border-green-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-gray-800">{{ item.device__centre__name|default:"Unassigned" }}</span>
                        <a href="{% url 'filtered_list' 'devices' %}?centre_id={{ item.centre_id }}" class="text-xs bg-white px-3 py-1 rounded-full text-gray-600 font-medium hover:underline">
                            {{ item.total }} devices
                        </a>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-2">
                        <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: {% if item.total > 0 %}{% widthratio item.completed item.total 100 %}{% else %}0{% endif %}%">
                            <span class="text-xs text-white font-bold">{% if item.total > 0 %}{% widthratio item.completed item.total 100 %}{% else %}0{% endif %}%</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600">{{ item.completed }} PPM done</p>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-slide-up" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-primary flex items-center">
                    <svg class="w-5 h-5 mr-2 text-accent" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
                    </svg>
                    Notifications
                </h3>
                {% if unread_count > 0 %}
                <span class="bg-error text-white text-xs font-bold px-3 py-1 rounded-full animate-pulse">{{ unread_count }} new</span>
                {% endif %}
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                {% for notification in notifications %}
                <div class="group p-4 {% if not notification.is_read %}bg-blue-50 border-l-4 border-accent{% else %}bg-gray-50{% endif %} rounded-xl hover:shadow-md transition-all duration-300 cursor-pointer">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mr-3">
                            {% if not notification.is_read %}
                            <span class="w-2 h-2 bg-accent rounded-full inline-block animate-pulse"></span>
                            {% else %}
                            <span class="w-2 h-2 bg-gray-400 rounded-full inline-block"></span>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-700 group-hover:text-gray-900">{{ notification.message }}</p>
                            <p class="text-xs text-gray-500 mt-1 flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                </svg>
                                {{ notification.created_at|date:"M d, Y H:i" }}
                            </p>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
                    </svg>
                    <p class="text-gray-500 text-sm">No notifications yet</p>
                </div>
                {% endfor %}
            </div>
            <a href="{% url 'notifications_view' %}" class="block text-center text-accent hover:text-blue-700 font-medium text-sm mt-4 py-2 hover:underline transition-colors">View All Notifications ‚Üí</a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-accent" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                </svg>
                Recent Devices
                <span class="ml-auto text-xs bg-accent text-white px-3 py-1 rounded-full">{{ recent_devices_count }} this month</span>
            </h3>
            <div class="overflow-x-auto max-h-96 custom-scrollbar">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Serial Number</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Hardware</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for device in recent_devices %}
                        <tr class="hover:bg-accent hover:bg-opacity-5 transition-colors duration-200">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <a href="{% url 'device_history' device.id %}" class="text-accent hover:text-blue-700 font-medium hover:underline">
                                    {{ device.serial_number|default:"N/A" }}
                                </a>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ device.hardware|default:"N/A" }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ device.date|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500 text-sm">No recent devices</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if recent_ppm_completions %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in" style="animation-delay: 0.1s;">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                Recent PPM Completions
            </h3>
            <div class="overflow-x-auto max-h-96 custom-scrollbar">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Device SN</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Period</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Completed</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for task in recent_ppm_completions %}
                        <tr class="hover:bg-green-50 transition-colors duration-200">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-800">
                                <a href="{% url 'device_history' task.device.id %}" class="text-accent hover:text-blue-700 hover:underline">
                                    {{ task.device.serial_number|default:"N/A" }}
                                </a>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                                <a href="{% url 'ppm_history' %}?period={{ task.period.name|urlencode }}" class="hover:underline">
                                    {{ task.period.name }}
                                </a>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">{{ task.completed_date|date:"M d, Y" }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500 text-sm">No recent completions</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="mb-8 mt-12 animate-fade-in">
        <h2 class="text-3xl font-bold text-primary mb-6">üõ°Ô∏è IT Operations Overview</h2>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <a href="{% url 'filtered_list' 'assets' %}" class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-red-500 transform hover:-translate-y-1 animate-scale-in">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Mission Critical Assets</p>
                    <p class="text-4xl font-bold text-red-600 mb-2">{{ critical_assets_count }}</p>
                    <div class="text-xs text-gray-600 space-y-1">
                        {% for item in asset_criticality_breakdown %}
                        <span>{{ item.criticality_level }}: <strong>{{ item.count }}</strong></span>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <div class="bg-red-500 bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path d="M11.94 2.06c.54.11 1.05.38 1.48.76.43.38.79.84 1.05 1.36.27.52.41 1.09.41 1.69 0 .6-.14 1.17-.41 1.69-.26.52-.62.98-1.05 1.36-.43.38-.94.65-1.48.76a3.9 3.9 0 01-1.94 0c-.54-.11-1.05-.38-1.48-.76s-.79-.84-1.05-1.36A3.87 3.87 0 017 7.87c0-.6.14-1.17.41-1.69.26-.52.62-.98 1.05-1.36.43-.38.94-.65 1.48-.76a3.9 3.9 0 011.94 0zM10 18c.83 0 1.5-.67 1.5-1.5S10.83 15 10 15s-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM3.5 18c.83 0 1.5-.67 1.5-1.5S4.33 15 3.5 15 2 15.67 2 16.5 2.67 18 3.5 18zM16.5 18c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM10 14c-1.3 0-2.52.4-3.56 1.11a.5.5 0 00-.22.65l.6 1.04c.15.26.47.36.75.22A5.92 5.92 0 0110 16c1.15 0 2.24.32 3.15.88.28.14.6.04.75-.22l.6-1.04a.5.5 0 00-.22-.65A5.9 5.9 0 0010 14z"/></svg>
                </div>
            </div>
        </a>

        <a href="{% url 'filtered_list' 'incidents' %}" class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-orange-500 transform hover:-translate-y-1 animate-scale-in">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Open Incidents</p>
                    <p class="text-4xl font-bold text-orange-600 mb-2">{{ open_incidents_count }}</p>
                    <p class="text-xs text-gray-600">{{ recent_incidents|length }} reported recently</p>
                </div>
                <div class="bg-orange-500 bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-orange-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                </div>
            </div>
        </a>

        <a href="{% url 'filtered_list' 'workplans' %}" class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-blue-500 transform hover:-translate-y-1 animate-scale-in">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Work Plan Compliance</p>
                    <p class="text-4xl font-bold text-blue-600 mb-2">{{ submitted_work_plans_count }}/{{ total_staff_for_work_plans }}</p>
                    <p class="text-xs text-gray-600">Submitted for current week</p>
                    {% if current_work_plan %}
                        <p class="text-xs text-green-600 mt-1">Your plan: Submitted</p>
                    {% else %}
                        <p class="text-xs text-red-600 mt-1">Your plan: Not Submitted</p>
                    {% endif %}
                </div>
                <div class="bg-blue-500 bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                </div>
            </div>
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                Recent Incidents
            </h3>
            <div class="overflow-x-auto max-h-96 custom-scrollbar">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Incident #</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for incident in recent_incidents %}
                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <a href="{% url 'filtered_list' 'incidents' %}?incident_number={{ incident.incident_number }}" class="text-accent hover:text-blue-700 font-medium hover:underline">
                                    {{ incident.incident_number }}
                                </a>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ incident.incident_type }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ incident.date_of_report|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500 text-sm">No recent incidents</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in" style="animation-delay: 0.1s;">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                Recent Backups
            </h3>
            <div class="overflow-x-auto max-h-96 custom-scrollbar">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">System</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Centre</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for backup in recent_backups %}
                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ backup.get_system_display }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ backup.centre.name }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ backup.date|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500 text-sm">No recent backups</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    Chart.defaults.font.family = "'Inter', 'system-ui', 'sans-serif'";
    Chart.defaults.plugins.legend.labels.usePointStyle = true;
    Chart.defaults.plugins.legend.labels.padding = 15;
    Chart.defaults.plugins.legend.labels.pointStyle = 'circle';

    const handleChartClick = (e, chart) => {
        const elements = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
        if (elements.length) {
            const firstElement = elements[0];
            const label = chart.data.labels[firstElement.index];
            const targetURL = chart.canvas.dataset.filterUrl;
            const paramName = chart.canvas.dataset.filterParam;
            if (!targetURL || !paramName) return;

            const url = new URL(targetURL, window.location.origin);
            if (paramName === 'ppm_status') {
                let status = 'all';
                if (label.includes('Done')) status = 'done';
                else if (label.includes('Not Done') || label.includes('Overdue')) status = 'pending';
                url.searchParams.append(paramName, status);
            } else {
                url.searchParams.append(paramName, label);
            }
            window.location.href = url.href;
        }
    };

    {% if device_status_breakdown %}
    const deviceStatusCtx = document.getElementById('deviceStatusChart').getContext('2d');
    const deviceStatusChart = new Chart(deviceStatusCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for item in device_status_breakdown %}'{{ item.status|default:"Unknown" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in device_status_breakdown %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#288CC8', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'],
                borderWidth: 3,
                borderColor: '#fff',
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (e) => handleChartClick(e, deviceStatusChart),
            plugins: {
                legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 } } },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            return ` ${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}

    {% if device_condition_breakdown %}
    const deviceConditionCtx = document.getElementById('deviceConditionChart').getContext('2d');
    const deviceConditionChart = new Chart(deviceConditionCtx, {
        type: 'pie',
        data: {
            labels: [{% for item in device_condition_breakdown %}'{{ item.device_condition|default:"Unknown" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in device_condition_breakdown %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#8B5CF6', '#EC4899'],
                borderWidth: 3,
                borderColor: '#fff',
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (e) => handleChartClick(e, deviceConditionChart),
            plugins: {
                legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 } } },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            return ` ${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}

    {% if ppm_status_labels %}
    const ppmStatusCtx = document.getElementById('ppmStatusChart').getContext('2d');
    const ppmStatusChart = new Chart(ppmStatusCtx, {
        type: 'bar',
        data: {
            labels: [{% for label in ppm_status_labels %}'{{ label }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Devices',
                data: [{% for data in ppm_status_data %}{{ data }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [{% for color in ppm_status_colors %}'{{ color }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                borderRadius: 10,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (e) => handleChartClick(e, ppmStatusChart),
            scales: { 
                y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' }, ticks: { font: { size: 11 } } },
                x: { grid: { display: false }, ticks: { font: { size: 11 } } }
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 }
                }
            }
        }
    });
    {% endif %}

    {% if devices_monthly %}
    const monthlyTrendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
    new Chart(monthlyTrendsCtx, {
        type: 'line',
        data: {
            labels: [{% for item in devices_monthly %}'{{ item.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [
                { 
                    label: 'Devices Added', 
                    data: [{% for item in devices_monthly %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}], 
                    borderColor: '#288CC8',
                    backgroundColor: 'rgba(40, 140, 200, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#288CC8',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                },
                { 
                    label: 'PPM Completed', 
                    data: [{% for item in ppm_completed_monthly %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}], 
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#10B981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: { 
                y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' }, ticks: { font: { size: 11 } } },
                x: { grid: { display: false }, ticks: { font: { size: 11 } } }
            },
            plugins: {
                legend: { position: 'top', labels: { padding: 20, font: { size: 12 } } },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 }
                }
            }
        }
    });
    {% endif %}
});
</script>

<style>
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-up { animation: slideUp 0.6s ease-out forwards; opacity: 0; }

    @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-down { animation: slideDown 0.4s ease-out; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.8s ease-in forwards; opacity: 0; }

    @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .animate-scale-in { animation: scaleIn 0.5s ease-out forwards; opacity: 0; }

    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1ff; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #288CC8; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #1e6a96; }

    a, button, .group { transition: all 0.3s ease; }
</style>
{% endblock %}