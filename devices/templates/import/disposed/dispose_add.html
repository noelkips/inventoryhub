{% extends "dashboard.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="bg-gradient-to-r from-red-600 to-red-800 text-white p-6">
            <h2 class="text-2xl font-bold">Dispose IT Device</h2>
            <p class="mt-2">Mark devices as permanently disposed â€¢ Single or Bulk upload</p>
        </div>

        <div class="p-6">
            {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                <div class="p-4 rounded-lg text-sm font-medium {% if message.tags == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                    {{ message }}
                </ dismissible>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- BULK UPLOAD -->
            <div class="mb-10 border-b pb-10">
                <h3 class="text-xl font-bold text-red-700 mb-5">Bulk Dispose via CSV</h3>
                <form method="post" enctype="multipart/form-data" class="bg-red-50 p-6 rounded-lg border border-red-200">
                    {% csrf_token %}
                    <div class="mb-5">
                        <label class="block text-gray-700 font-semibold mb-2">Upload CSV File *</label>
                        <input type="file" name="file" accept=".csv" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <p class="text-sm text-gray-600 mt-2">
                            Required: <code class="bg-white px-2 py-1 rounded">serial_number</code>,
                            <code class="bg-white px-2 py-1 rounded">hardware</code>,
                            <code class="bg-white px-2 py-1 rounded">disposal_reason</code>
                            <br><span class="text-xs">All other fields optional (same as Add Device)</span>
                        </p>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold px-8 py-3 rounded-lg">
                            Upload & Dispose
                        </button>
                        <a href="{% url 'download_dispose_template' %}" class="bg-gray-700 hover:bg-gray-800 text-white font-bold px-8 py-3 rounded-lg">
                            Download Template
                        </a>
                        <button type="button" onclick="showModal('disposeGuideModal')" class="bg-red-800 hover:bg-red-900 text-white font-bold px-8 py-3 rounded-lg">
                            Upload Guide
                        </button>
                    </div>
                </form>
            </div>

            <!-- SINGLE ADD -->
            <div class="mb-8">
                <button onclick="showModal('disposeModal')" 
                        class="bg-red-600 hover:bg-red-700 text-white font-bold px-8 py-3 rounded-lg shadow-md">
                    Add Single Disposed Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SINGLE DISPOSE MODAL -->
<div id="disposeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center overflow-y-auto">
    <div class="bg-white p-8 rounded-lg w-full max-w-5xl mx-4 shadow-2xl max-h-screen overflow-y-auto">
        <h3 class="text-2xl font-bold text-red-700 mb-6">Dispose Single Device</h3>
        <form method="post">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                <!-- REQUIRED -->
                <div>
                    <label class="block font-semibold text-red-700 mb-1">Serial Number *</label>
                    <input type="text" name="serial_number" required class="w-full p-2 border rounded focus:ring-2 focus:ring-red-500">
                </div>
                <div>
                    <label class="block font-semibold text-red-700 mb-1">Hardware *</label>
                    <input type="text" name="hardware" required class="w-full p-2 border rounded focus:ring-2 focus:ring-red-500">
                </div>
                <div class="md:col-span-3">
                    <label class="block font-semibold text-red-700 mb-1">Disposal Reason *</label>
                    <textarea name="disposal_reason" required rows="3" class="w-full p-2 border rounded focus:ring-2 focus:ring-red-500"></textarea>
                </div>

                <!-- OPTIONAL FIELDS (same as Add Device) -->
                <div><label class="block font-semibold mb-1">System Model</label><input type="text" name="system_model" class="w-full p-2 border rounded"></div>
                <div><label class="block font-semibold mb-1">Processor</label><input type="text" name="processor" class="w-full p-2 border rounded"></div>
                <div><label class="block font-semibold mb-1">RAM (GB)</label><input type="text" name="ram_gb" class="w-full p-2 border rounded"></div>
                <div><label class="block font-semibold mb-1">HDD (GB)</label><input type="text" name="hdd_gb" class="w-full p-2 border rounded"></div>
                <div><label class="block font-semibold mb-1">Assignee First Name</label><input type="text" name="assignee_first_name" class="w-full p-2 border rounded"></div>
                <div><label class="block font-semibold mb-1">Assignee Last Name</label><input type="text" name="assignee_last_name" class="w-full p-2 border rounded"></div>
                <div><label class="block font-semibold mb-1">Assignee Email</label><input type="email" name="assignee_email_address" class="w-full p-2 border rounded"></div>
                <div><label class="block font-semibold mb-1">Device Condition</label><input type="text" name="device_condition" class="w-full p-2 border rounded"></div>
                <div><label class="block font-semibold mb-1">Status</label><input type="text" name="status" class="w-full p-2 border rounded"></div>
            </div>

            <div class="flex justify-end gap-4 mt-8">
                <button type="button" onclick="closeModal('disposeModal')" class="px-8 py-3 bg-gray-500 text-white rounded hover:bg-gray-600">Cancel</button>
                <button type="submit" class="px-8 py-3 bg-red-600 text-white rounded hover:bg-red-700 font-bold">Dispose Device</button>
            </div>
        </form>
    </div>
</div>

<!-- UPLOAD GUIDE MODAL -->
<div id="disposeGuideModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg max-w-3xl mx-4 max-h-screen overflow-y-auto">
        <h3 class="text-2xl font-bold text-red-700 mb-4">CSV Disposal Guide</h3>
        <div class="space-y-4 text-gray-700">
            <p class="font-semibold">Required columns:</p>
            <ul class="list-disc ml-6 space-y-1">
                <li><code class="bg-gray-100 px-2 py-1 rounded">serial_number</code> *</li>
                <li><code class="bg-gray-100 px-2 py-1 rounded">hardware</code> *</li>
                <li><code class="bg-gray-100 px-2 py-1 rounded">disposal_reason</code> *</li>
            </ul>
            <p class="font-semibold mt-4">Optional columns (recommended):</p>
            <ul class="list-disc ml-6 space-y-1 text-sm">
                <li><code class="bg-gray-100 px-1 py-0.5 rounded">system_model</code></li>
                <li><code class="bg-gray-100 px-1 py-0.5 rounded">processor</code>, <code class="bg-gray-100 px-1 py-0.5 rounded">ram_gb</code>, <code class="bg-gray-100 px-1 py-0.5 rounded">hdd_gb</code></li>
                <li><code class="bg-gray-100 px-1 py-0.5 rounded">assignee_first_name</code>, <code class="bg-gray-100 px-1 py-0.5 rounded">assignee_last_name</code>, <code class="bg-gray-100 px-1 py-0.5 rounded">assignee_email_address</code></li>
                <li><code class="bg-gray-100 px-1 py-0.5 rounded">device_condition</code>, <code class="bg-gray-100 px-1 py-0.5 rounded">status</code></li>
            </ul>
            <div class="bg-yellow-100 p-4 rounded border-l-4 border-yellow-500 mt-4">
                <p class="font-semibold">Warning:</p>
                <p class="text-sm">If the <code>serial_number</code> already exists in the system, it will be <strong>skipped</strong>. Use the normal disposal workflow for existing devices.</p>
            </div>
        </div>
        <div class="mt-6 text-right">
            <button onclick="closeModal('disposeGuideModal')" class="bg-red-600 text-white px-8 py-3 rounded hover:bg-red-700">Got it!</button>
        </div>
    </div>
</div>

<script>
function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
window.onclick = function(e) { if (e.target.classList.contains('fixed')) closeModal(e.target.id); }
</script>
{% endblock %}