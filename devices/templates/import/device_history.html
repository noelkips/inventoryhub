{% extends 'dashboard.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto p-2 sm:p-4 max-w-full">
    <!-- Navigation Links -->
    <div class="mb-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
        <a href="{% url 'display_approved_imports' %}" class="text-blue-600 hover:underline text-sm sm:text-base">Back to Approved Devices</a>
        <a href="{% url 'display_unapproved_imports' %}" class="text-blue-600 hover:underline text-sm sm:text-base">Back to Unapproved Devices</a>
        <a href="{% url 'display_disposed_imports' %}" class="text-blue-600 hover:underline text-sm sm:text-base">Back to Disposed Devices</a>
        <a href="{% url 'device_detail' device.pk %}" class="text-blue-600 hover:underline text-sm sm:text-base">Back to Device Details</a>
    </div>

    <!-- Hero Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-blue-700 text-white rounded-2xl shadow-2xl p-8 mb-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold mb-2">Device History</h1>
        <p class="text-xl sm:text-2xl opacity-90">{{ device.serial_number|default:"N/A" }}</p>
        <p class="text-lg opacity-80 mt-2">{{ device.system_model|default:"Unknown Model" }}</p>
    </div>

    <!-- Professional Device Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        <!-- Card 1: Identification & Category -->
        <div class="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-shadow">
            <h3 class="text-lg font-bold text-indigo-700 mb-5 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Device Identification
            </h3>
            <dl class="space-y-3 text-sm">
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Serial Number:</dt><dd class="font-semibold">{{ device.serial_number|default:"N/A" }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Category:</dt><dd class="font-semibold">{{ device.get_category_display|default:"N/A" }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Device Name:</dt><dd class="font-semibold">{{ device.device_name|default:"N/A" }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">System Model:</dt><dd class="font-semibold">{{ device.system_model|default:"N/A" }}</dd></div>
            </dl>
        </div>

        <!-- Card 2: Hardware Specifications -->
        <div class="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-shadow">
            <h3 class="text-lg font-bold text-indigo-700 mb-5 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                Hardware Specifications
            </h3>
            <dl class="space-y-3 text-sm">
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Processor:</dt><dd class="font-semibold">{{ device.processor|default:"N/A" }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">RAM:</dt><dd class="font-semibold">{{ device.ram_gb|default:"N/A" }} GB</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Storage:</dt><dd class="font-semibold">{{ device.hdd_gb|default:"N/A" }} GB</dd></div>
            </dl>
        </div>

        <!-- Card 3: Current Assignment & Location -->
        <div class="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-shadow">
            <h3 class="text-lg font-bold text-indigo-700 mb-5 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                Assignment & Location
            </h3>
            <dl class="space-y-3 text-sm">
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Current Assignee:</dt><dd class="font-semibold truncate max-w-xs">
                    {% if device.assignee %}
                        {{ device.assignee.full_name }} ({{ device.assignee.staff_number|default:"No ID" }})
                    {% else %}
                        <span class="text-red-600">Unassigned</span>
                    {% endif %}
                </dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Centre:</dt><dd class="font-semibold">{{ device.centre.name|default:"N/A" }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Department:</dt><dd class="font-semibold">{{ device.department.name|default:"N/A" }}</dd></div>
            </dl>
        </div>

        <!-- Card 4: Status & Administrative -->
        <div class="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-shadow">
            <h3 class="text-lg font-bold text-indigo-700 mb-5 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                </svg>
                Status & Administrative
            </h3>
            <dl class="space-y-3 text-sm">
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Condition:</dt><dd class="font-semibold">{{ device.device_condition|default:"N/A" }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Status:</dt><dd class="font-semibold">{{ device.status|default:"N/A" }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Added On:</dt><dd class="font-semibold">{{ device.date|date:"d M Y" }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-600">Approved:</dt><dd class="font-semibold">{{ device.is_approved|yesno:"Yes,No" }}</dd></div>
            </dl>
        </div>
    </div>

    <!-- Device Tracking Timeline (Most recent first) -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center">
            <svg class="w-7 h-7 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Device Tracking Timeline
        </h3>
        <p class="text-sm text-gray-600 mb-6">Historical periods of assignment, location, status, and condition (most recent first).</p>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr class="bg-indigo-700 text-white">
                        <th class="py-4 px-6 text-left text-sm font-semibold">Start</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">End</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Assignee name and staff no</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Department</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Centre</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Status</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Condition</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Changed By</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for entry in timeline %}
                    <tr class="{% if entry.end_date == 'Current' %}bg-green-50 font-medium{% else %}hover:bg-gray-50{% endif %} transition">
                        <td class="py-4 px-6 text-sm">{{ entry.start_date|date:"d M Y H:i" }}</td>
                        <td class="py-4 px-6 text-sm">
                            {% if entry.end_date == 'Current' %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-600 text-white">Ongoing</span>
                            {% else %}
                                {{ entry.end_date|date:"d M Y H:i" }}
                            {% endif %}
                        </td>
                        <td class="py-4 px-6 text-sm">{{ entry.assignee }}</td>
                        <td class="py-4 px-6 text-sm">{{ entry.department }}</td>
                        <td class="py-4 px-6 text-sm">{{ entry.centre }}</td>
                        <td class="py-4 px-6 text-sm">{{ entry.status }}</td>
                        <td class="py-4 px-6 text-sm">{{ entry.condition }}</td>
                        <td class="py-4 px-6 text-sm text-gray-600">{{ entry.changed_by }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="8" class="py-12 text-center text-gray-500">No tracking data available</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Past UAF Agreements -->
    {% if past_agreements %}
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-2xl shadow-xl mb-8 border-2 border-blue-300">
        <div class="flex items-center mb-5">
            <svg class="w-7 h-7 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-xl font-bold text-blue-900">Past User Agreement Forms (UAF)</h3>
        </div>
        <p class="text-sm text-blue-800 mb-6">Complete history of all device assignments with downloadable UAF documents</p>
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-blue-600 text-white">
                        <th class="py-4 px-6 text-left text-sm font-semibold">Employee</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Staff ID</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Issued</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Cleared</th>
                        <th class="py-4 px-6 text-left text-sm font-semibold">Status</th>
                        <th class="py-4 px-6 text-center text-sm font-semibold">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for agreement in past_agreements %}
                    <tr class="hover:bg-blue-50 transition">
                        <td class="py-4 px-6 text-sm">
                            <div class="font-medium text-gray-900">{{ agreement.employee.full_name }}</div>
                            <div class="text-xs text-gray-500">{{ agreement.employee.email|default:"No email" }}</div>
                        </td>
                        <td class="py-4 px-6 text-sm text-gray-700">{{ agreement.employee.staff_number|default:"N/A" }}</td>
                        <td class="py-4 px-6 text-sm">
                            <div class="text-gray-900">{{ agreement.issuance_date|date:"d M Y" }}</div>
                            <div class="text-xs text-gray-500">by {{ agreement.issuance_it_user.get_full_name|default:agreement.issuance_it_user.username }}</div>
                        </td>
                        <td class="py-4 px-6 text-sm">
                            {% if agreement.clearance_date %}
                                <div class="text-gray-900">{{ agreement.clearance_date|date:"d M Y" }}</div>
                                <div class="text-xs text-gray-500">by {{ agreement.clearance_it_user.get_full_name|default:agreement.clearance_it_user.username }}</div>
                            {% else %}
                                <span class="text-orange-600 font-medium">Not Cleared</span>
                            {% endif %}
                        </td>
                        <td class="py-4 px-6">
                            {% if agreement.user_signed_clearance %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    Complete
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    Issued Only
                                </span>
                            {% endif %}
                        </td>
                        <td class="py-4 px-6 text-center">
                            <a href="{% url 'download_past_uaf_pdf' agreement.pk %}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition shadow">
                                Download UAF
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-5 p-4 bg-blue-100 rounded-lg border border-blue-300">
            <div class="flex items-start">
                <div class="text-sm text-blue-900">
                    <strong>Note:</strong> These are archived agreements for previous users. Each UAF contains both issuance and clearance sections (if device was properly cleared). Current assignment UAF can be downloaded from the device detail page.
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Current Active Agreement -->
    {% if current_agreement %}
    <div class="bg-green-50 p-6 rounded-2xl shadow-xl mb-8 border-l-4 border-green-500">
        <h3 class="text-xl font-semibold mb-4 text-green-900 flex items-center">
            Current Active Agreement
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <p><strong>Current User:</strong> {{ current_agreement.employee.full_name }}</p>
            <p><strong>Issued On:</strong> {{ current_agreement.issuance_date|date:"d M Y" }}</p>
            <p><strong>Staff ID:</strong> {{ current_agreement.employee.staff_number|default:"N/A" }}</p>
            <p><strong>Status:</strong> 
                {% if current_agreement.user_signed_issuance %}
                    <span class="text-green-600 font-medium">Signed</span>
                {% else %}
                    <span class="text-orange-600 font-medium">Pending Signature</span>
                {% endif %}
            </p>
        </div>
        <div class="mt-5">
            <a href="{% url 'device_detail' device.pk %}" class="inline-flex items-center px-5 py-3 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition">
                View Current Assignment Details
            </a>
        </div>
    </div>
    {% endif %}

   

    <!-- Previous Users (Legacy Data) -->
    <div class="bg-white rounded-2xl shadow-xl p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-5">Previous Users (Legacy Data)</h3>
        {% if user_history %}
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700">
                            <th class="py-4 px-6 text-left text-sm font-semibold">Assignee Name</th>
                            <th class="py-4 px-6 text-left text-sm font-semibold">Email</th>
                            <th class="py-4 px-6 text-left text-sm font-semibold">Assigned By</th>
                            <th class="py-4 px-6 text-left text-sm font-semibold">Assigned Date</th>
                            <th class="py-4 px-6 text-left text-sm font-semibold">Cleared Date</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for entry in user_history %}
                        <tr class="hover:bg-gray-50 transition">
                            <td class="py-4 px-6 text-sm">{{ entry.assignee_first_name }}</td>
                            <td class="py-4 px-6 text-sm">{{ entry.email }}</td>
                            <td class="py-4 px-6 text-sm">{{ entry.assigned_by }}</td>
                            <td class="py-4 px-6 text-sm">{{ entry.assigned_date|date:"d M Y" }}</td>
                            <td class="py-4 px-6 text-sm">{{ entry.cleared_date|date:"d M Y"|default:"N/A" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-600 py-8 text-center">No previous users recorded.</p>
        {% endif %}
    </div>
</div>
{% endblock %}