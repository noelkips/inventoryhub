{% extends 'dashboard.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-2 py-4 max-w-5xl">
    <div class="bg-white shadow-xl rounded-lg overflow-hidden border border-gray-300">
        <!-- Header -->
        <div class="bg-gradient-to-r from-[#143C50] to-[#288CC8] text-white px-4 py-3">
            <h1 class="text-2xl font-bold">
                {% if signing_type == 'issuance' %}
                    Device Issuance Agreement
                {% else %}
                    Device Clearance - Return to IT
                {% endif %}
            </h1>
            <p class="text-sm opacity-90">{{ device.serial_number }} - {{ category_display }} | Staff: {{ device.assignee.full_name }}</p>
        </div>

        <div class="px-4 py-3">
            {% if messages %}
            <div class="mb-3 space-y-2">
                {% for message in messages %}
                <div class="p-3 rounded border-l-4 text-sm {% if message.tags == 'error' %}bg-red-50 border-red-500 text-red-700{% else %}bg-green-50 border-green-500 text-green-700{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if signing_type == 'issuance' %}
            <!-- Agreement Text - Compact and scrollable -->
            <div class="mb-4 max-h-64 overflow-y-auto border border-gray-300 rounded p-3 bg-gray-50 text-xs">
               

                <h3 class="text-sm font-bold text-center mb-1">MISSIONS OF HOPE INTERNATIONAL</h3>
                <h4 class="text-xs font-bold text-center mb-3">MOHI DEVICE USAGE AGREEMENT FORM</h4>

                <h5 class="font-bold mb-1 text-xs">General information</h5>
                <ul class="list-disc pl-4 space-y-0.5 mb-2 text-xs leading-tight">
                    <li>Only MOHI staff with a current MOHI ID may be assigned a work designated device.</li>
                    <li>The person who checked out the device is fully responsible for the device care.</li>
                    <li>All electronic devices must be used only at MOHI Centers and for MOHI work.</li>
                    <li>All web browsing shall be dedicated to MOHI work, no social media, streaming sites, or torrent sites.</li>
                </ul>
                
                <p class="font-bold mb-2 text-xs text-red-700">Violation will result in confiscation and possible termination.</p>
                <p class="font-bold mb-2 text-sm text-center text-red-700">DO NOT LEAVE THE DEVICE UNATTENDED</p>
                <p class="mb-2 text-xs">This agreement is binding for all staff and will be kept on file in the I.T Office.</p>

                <h5 class="font-bold mb-1 text-xs">By my signature below, I agree to:</h5>
                <ul class="list-disc pl-4 space-y-0.5 mb-3 text-xs leading-tight">
                    <li>I have read, understood and accept the above conditions.</li>
                    <li>I will not leave the device unattended.</li>
                    <li>I accept full responsibility for the <u>{{ category_display }}</u> and accessories and agree to reimburse MOHI for full cost of repair/replacement if lost, stolen, or damaged.</li>
                    <li>I will not add, delete, or alter hardware, software, or settings without IT Department approval.</li>
                    <li>This agreement is binding until the <u>{{ category_display }}</u> is returned in good condition to MOHI IT Department.</li>
                </ul>
            </div>
            {% endif %}

            {% if signing_type == 'clearance' %}
            <!-- Clearance Info - Compact -->
            <div class="bg-blue-50 border-2 border-blue-300 rounded p-3 mb-3">
                <h3 class="text-base font-bold text-blue-900 mb-2">Device Return Information</h3>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><span class="font-semibold">Issued To:</span> {{ agreement.employee.full_name }}</div>
                    <div><span class="font-semibold">Issued:</span> {{ agreement.issuance_date|date:"d M Y" }}</div>
                    <div><span class="font-semibold">Device:</span> {{ category_display }}</div>
                    <div><span class="font-semibold">Serial:</span> {{ device.serial_number }}</div>
                </div>
            </div>
            {% endif %}

            <!-- Signature Form -->
            <form method="post" id="signForm">
                {% csrf_token %}
                <input type="hidden" name="user_signature_png" id="user_signature_png">
                {% if signing_type == 'issuance' %}
                <input type="hidden" name="it_signature_png" id="it_signature_png">
                {% endif %}

                {% if signing_type == 'issuance' %}
                <!-- Terms Agreement -->
                <div class="flex items-start p-2 bg-yellow-50 border-2 border-yellow-400 rounded mb-3">
                    <input type="checkbox" id="agree_terms" name="agree_terms" 
                           class="mt-0.5 mr-2 h-4 w-4 text-[#288CC8]" required>
                    <label for="agree_terms" class="text-xs font-semibold cursor-pointer">
                        I have read and agree to all Terms & Conditions above
                    </label>
                </div>

                <!-- Staff Information Display -->
                <div class="bg-gray-100 p-2 rounded mb-3 text-xs">
                    <div class="grid grid-cols-3 gap-2">
                        <div><span class="font-semibold">Staff:</span> {{ device.assignee.full_name }}</div>
                        <div><span class="font-semibold">MOHI ID:</span> {{ device.assignee.staff_number|default:"N/A" }}</div>
                        <div><span class="font-semibold">Role:</span> {{ device.assignee.designation|default:"N/A" }}</div>
                    </div>
                </div>
                {% endif %}

                {% if signing_type == 'clearance' %}
                <!-- Remarks -->
                <div class="mb-3">
                    <label for="remarks" class="block text-xs font-semibold text-gray-700 mb-1">
                        Device Condition / Remarks (Optional)
                    </label>
                    <textarea name="remarks" id="remarks" rows="2" 
                              class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-[#288CC8]"
                              placeholder="Any issues or notes about the device condition"></textarea>
                </div>
                {% endif %}

                <!-- ENHANCED Signature Section with Larger Canvas -->
                <div class="border-2 border-[#143C50] rounded p-3 mb-3">
                    <h3 class="text-sm font-bold text-[#143C50] mb-2">
                        {% if signing_type == 'issuance' %}Issuance Signatures{% else %}Handing Over to I.T Department{% endif %}
                    </h3>
                    
                    <div class="grid {% if signing_type == 'issuance' %}grid-cols-2{% else %}grid-cols-1{% endif %} gap-3">
                        <!-- Employee Signature -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                {% if signing_type == 'issuance' %}
                                    Staff Signature
                                {% else %}
                                    Staff Signature (Returning Device)
                                {% endif %}
                            </label>
                            <div class="bg-white border-2 border-gray-400 rounded overflow-hidden">
                                <canvas id="user-signature-pad" class="w-full cursor-crosshair" height="150"></canvas>
                            </div>
                            <button type="button" id="clear-user-btn" 
                                    class="mt-1 px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">
                                Clear
                            </button>
                        </div>

                        {% if signing_type == 'issuance' %}
                        <!-- IT Staff Signature - Only for issuance -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                I.T Staff Signature
                            </label>
                            <div class="bg-white border-2 border-gray-400 rounded overflow-hidden">
                                <canvas id="it-signature-pad" class="w-full cursor-crosshair" height="150"></canvas>
                            </div>
                            <button type="button" id="clear-it-btn" 
                                    class="mt-1 px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">
                                Clear
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Compact Action Buttons -->
                <div class="flex justify-between items-center gap-3">
                    <a href="{% url 'device_detail' device.pk %}"
                       class="px-6 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-xs font-medium">
                        Cancel
                    </a>

                    <button type="submit" id="sign-btn" disabled
                            class="px-8 py-2 bg-[#288CC8] text-white rounded hover:bg-[#143C50] text-xs font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                        {% if signing_type == 'issuance' %}Sign & Submit{% else %}Submit Return{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Signature Pad Library -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
<script>
    const signingType = '{{ signing_type }}';
    
    // Employee Signature Pad
    const userCanvas = document.getElementById('user-signature-pad');
    const userPad = new SignaturePad(userCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 0.8,
        maxWidth: 2.5,  // Increased for better visibility
    });

    // IT Staff Signature Pad (only for issuance)
    let itPad = null;
    if (signingType === 'issuance') {
        const itCanvas = document.getElementById('it-signature-pad');
        itPad = new SignaturePad(itCanvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)',
            minWidth: 0.8,
            maxWidth: 2.5,  // Increased for better visibility
        });
    }

    const clearUserBtn = document.getElementById('clear-user-btn');
    const clearItBtn = document.getElementById('clear-it-btn');
    const signBtn = document.getElementById('sign-btn');
    const agreeBox = document.getElementById('agree_terms');
    const userSigInput = document.getElementById('user_signature_png');
    const itSigInput = document.getElementById('it_signature_png');

    function resizeCanvases() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        
        [userCanvas].forEach(canvas => {
            if (canvas) {
                const parent = canvas.parentElement;
                canvas.width = parent.offsetWidth * ratio;
                canvas.height = 150 * ratio;  // Updated to match new height
                canvas.getContext('2d').scale(ratio, ratio);
            }
        });

        if (itPad && document.getElementById('it-signature-pad')) {
            const itCanvas = document.getElementById('it-signature-pad');
            const parent = itCanvas.parentElement;
            itCanvas.width = parent.offsetWidth * ratio;
            itCanvas.height = 150 * ratio;  // Updated to match new height
            itCanvas.getContext('2d').scale(ratio, ratio);
        }
    }

    window.addEventListener('resize', resizeCanvases);
    resizeCanvases();

    function updateSubmitButton() {
        const hasUserSig = !userPad.isEmpty();
        
        if (signingType === 'issuance') {
            const hasItSig = itPad && !itPad.isEmpty();
            const agreed = agreeBox ? agreeBox.checked : false;
            signBtn.disabled = !(hasUserSig && hasItSig && agreed);
        } else {
            signBtn.disabled = !hasUserSig;
        }
    }

    clearUserBtn.addEventListener('click', () => { userPad.clear(); updateSubmitButton(); });
    if (clearItBtn) {
        clearItBtn.addEventListener('click', () => { if (itPad) itPad.clear(); updateSubmitButton(); });
    }
    
    if (agreeBox) {
        agreeBox.addEventListener('change', updateSubmitButton);
    }
    
    userPad.addEventListener('endStroke', updateSubmitButton);
    if (itPad) {
        itPad.addEventListener('endStroke', updateSubmitButton);
    }

    updateSubmitButton();

    document.getElementById('signForm').addEventListener('submit', (e) => {
        if (userPad.isEmpty()) {
            e.preventDefault();
            alert('Please draw your signature.');
            return;
        }
        
        if (signingType === 'issuance') {
            if (itPad && itPad.isEmpty()) {
                e.preventDefault();
                alert('IT staff signature is required.');
                return;
            }
            
            if (agreeBox && !agreeBox.checked) {
                e.preventDefault();
                alert('You must agree to the terms.');
                return;
            }
        }
        
        userSigInput.value = userPad.toDataURL('image/png');
        if (signingType === 'issuance' && itPad) {
            itSigInput.value = itPad.toDataURL('image/png');
        }
    });
</script>
{% endblock %}