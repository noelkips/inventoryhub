{% extends 'dashboard.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto p-4">
  <h2 class="text-2xl font-bold mb-4 text-gray-800">Manage Users</h2>

  <!-- Breadcrumbs -->
  <nav class="text-sm mb-4">
    <ul class="flex space-x-2">
      <li><a href="{% url 'dashboard' %}" class="text-blue-600 hover:text-blue-800 transition">Dashboard</a></li>
      <li><span class="text-gray-500">/</span></li>
      <li><span class="text-gray-700">Manage Users</span></li>
    </ul>
  </nav>

  <!-- Messages -->
  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <div class="bg-{% if message.tags == 'error' %}red{% else %}green{% endif %}-100 border border-{% if message.tags == 'error' %}red{% else %}green{% endif %}-400 text-{% if message.tags == 'error' %}red{% else %}green{% endif %}-700 px-4 py-3 rounded animate__animated animate__fadeIn" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Action Buttons -->
  <div class="mb-4 flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
    <button onclick="showModal('add')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full sm:w-auto">Add User</button>
    {% if request.user.is_superuser %}
      <button onclick="showModal('manage_groups')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full sm:w-auto">Manage Groups</button>
    {% endif %}
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border shadow-sm">
      <thead>
        <tr class="bg-gradient-to-r from-blue-600 to-blue-800 text-white">
          <th class="py-3 px-4 border text-left">User Details</th>
          <th class="py-3 px-4 border text-left">Centre & Role</th>
          <th class="py-3 px-4 border text-left">Groups</th>
          <th class="py-3 px-4 border text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
        {% for user in users %}
          <tr class="hover:bg-gray-50 transition"
              data-user-id="{{ user.pk }}"
              data-username="{{ user.username }}"
              data-email="{{ user.email }}"
              data-first-name="{{ user.first_name|default:'' }}"
              data-last-name="{{ user.last_name|default:'' }}"
              data-centre="{{ user.centre.name|default:'N/A' }}"
              data-is-trainer="{{ user.is_trainer }}"
              data-is-staff="{{ user.is_staff }}"
              data-is-superuser="{{ user.is_superuser }}"
              data-is-it-manager="{{ user.is_it_manager }}"
              data-is-senior-it-officer="{{ user.is_senior_it_officer }}"
              data-groups="{% for g in user.groups.all %}{{ g.name }}{% if not forloop.last %}, {% endif %}{% endfor %}">
            <td class="py-2 px-4 border">
              <strong>Username:</strong> {{ user.username }}<br>
              <strong>Email:</strong> {{ user.email }}
            </td>
            <td class="py-2 px-4 border">
              <strong>Centre:</strong> {{ user.centre.name|default:"N/A" }}<br>
              <strong>Role:</strong>
              {% if user.is_it_manager %}IT Manager{% elif user.is_senior_it_officer %}Senior IT Officer{% elif user.is_trainer %}Trainer{% elif user.is_staff %}Staff{% else %}User{% endif %}
            </td>
            <td class="py-2 px-4 border">{{ user.groups.all|join:", "|default:"N/A" }}</td>
            <td class="py-2 px-4 border flex flex-wrap gap-1 text-xs">
              <button onclick="showModal('view', {{ user.pk }})" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">View</button>
              <button onclick="showModal('update', {{ user.pk }})" class="bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700">Edit</button>

              {% if request.user.is_it_manager or request.user.is_senior_it_officer %}
                <button onclick="showModal('delete', {{ user.pk }})" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">Delete</button>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="py-2 px-4 border text-center text-gray-600">No users found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- VIEW MODAL -->
  <div id="viewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-blue-800">User Details</h3>
        <button onclick="closeModal('viewModal')" class="text-gray-600 hover:text-gray-800 text-2xl">x</button>
      </div>
      <div class="space-y-3 text-gray-700">
        <p><strong>Username:</strong> <span id="viewUsername"></span></p>
        <p><strong>Email:</strong> <span id="viewEmail"></span></p>
        <p><strong>Name:</strong> <span id="viewName"></span></p>
        <p><strong>Centre:</strong> <span id="viewCentre"></span></p>
        <p><strong>Role:</strong> <span id="viewRole"></span></p>
        <p><strong>Groups:</strong> <span id="viewGroups"></span></p>
      </div>
      <div class="mt-6 flex justify-end">
        <button onclick="closeModal('viewModal')" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Close</button>
      </div>
    </div>
  </div>

  <!-- UPDATE MODAL (existing) -->
  <div id="userModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl mx-4 md:mx-6 max-h-[90vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 rounded-t-lg flex justify-between items-center">
        <h3 id="modalTitle" class="text-xl font-semibold"></h3>
        <button onclick="closeModal('userModal')" class="text-white hover:bg-gray-200 hover:text-gray-800 rounded-full p-2">x</button>
      </div>
      <div class="p-8">
        <form id="userForm" method="post" action="" class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {% csrf_token %}
          <input type="hidden" id="userId" name="user_id">
          <div>
            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">Username</label>
              <input type="text" name="username" id="username" class="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">Email</label>
              <input type="email" name="email" id="email" class="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">Password</label>
              <input type="password" name="password" id="password" class="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
              <p class="text-xs text-gray-500 mt-1">Leave blank to keep current password.</p>
            </div>
          </div>
          <div>
            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">First Name</label>
              <input type="text" name="first_name" id="first_name" class="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">Last Name</label>
              <input type="text" name="last_name" id="last_name" class="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">Centre</label>
              <select name="centre" id="centre" class="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Select Centre</option>
                {% for centre in centres %}
                  <option value="{{ centre.id }}">{{ centre.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          {% if request.user.is_it_manager or request.user.is_senior_it_officer %}
          <div id="roleSection">
            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">Groups</label>
              <select name="groups" id="groups" multiple class="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                {% for group in groups %}
                  <option value="{{ group.id }}">{{ group.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-4 grid grid-cols-2 gap-2">
              <label class="flex items-center">
                <input type="checkbox" name="is_trainer" id="is_trainer" class="mr-2">
                <span>Is Trainer</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="is_staff" id="is_staff" class="mr-2">
                <span>Is Staff</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="is_superuser" id="is_superuser" class="mr-2">
                <span>Is Superuser</span>
              </label>
            </div>
          </div>
          {% else %}
          <div class="bg-gray-50 p-4 rounded border">
            <h4 class="font-semibold text-gray-700 mb-2">Current Roles (Read-Only)</h4>
            <p><strong>Trainer:</strong> <span id="readonlyTrainer">No</span></p>
            <p><strong>Staff:</strong> <span id="readonlyStaff">No</span></p>
            <p><strong>Superuser:</strong> <span id="readonlySuperuser">No</span></p>
            <p><strong>IT Manager:</strong> <span id="readonlyItManager">No</span></p>
            <p><strong>Senior IT Officer:</strong> <span id="readonlySeniorOfficer">No</span></p>
            <p><strong>Groups:</strong> <span id="readonlyGroups">None</span></p>
          </div>
          <input type="hidden" name="groups" value="">
          <input type="hidden" name="is_trainer" value="false">
          <input type="hidden" name="is_staff" value="false">
          <input type="hidden" name="is_superuser" value="false">
          {% endif %}

          <div class="col-span-1 md:col-span-3 flex justify-end space-x-3">
            <button type="button" onclick="closeModal('userModal')" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- DELETE MODAL -->
  {% if request.user.is_it_manager or request.user.is_senior_it_officer %}
  <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md mx-4">
      <h3 class="text-lg font-bold mb-4 text-red-600">Delete User</h3>
      <p class="text-gray-700 mb-4">Are you sure you want to <strong>permanently delete</strong> this user?</p>
      <p class="text-sm text-gray-600 mb-4">
        <strong>Username:</strong> <span id="deleteUsername" class="font-medium"></span>
      </p>
      <form id="deleteForm" method="post" action="">
        {% csrf_token %}
        <input type="hidden" id="deleteUserId" name="user_id">
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeModal('deleteModal')" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete User</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</div>

<script>
const canEditRoles = {{ request.user.is_it_manager|yesno:"true,false" }} || {{ request.user.is_senior_it_officer|yesno:"true,false" }};

function showModal(action, userId = null) {
  const row = userId ? document.querySelector(`tr[data-user-id="${userId}"]`) : null;

  if (action === 'add') {
    document.getElementById('modalTitle').textContent = 'Add User';
    document.getElementById('userForm').action = "{% url 'user_add' %}";
    resetForm();
    document.getElementById('userModal').classList.remove('hidden');

  } else if (action === 'update' && row) {
    document.getElementById('modalTitle').textContent = 'Update User';
    document.getElementById('userForm').action = "{% url 'user_update' 999 %}".replace('999', userId);
    populateForm(row);
    document.getElementById('userModal').classList.remove('hidden');

  } else if (action === 'view' && row) {
    document.getElementById('viewUsername').textContent = row.dataset.username;
    document.getElementById('viewEmail').textContent = row.dataset.email;
    document.getElementById('viewName').textContent = `${row.dataset.firstName} ${row.dataset.lastName}`.trim() || 'â€”';
    document.getElementById('viewCentre').textContent = row.dataset.centre;
    const role = row.dataset.isItManager === 'true' ? 'IT Manager' :
                 row.dataset.isSeniorItOfficer === 'true' ? 'Senior IT Officer' :
                 row.dataset.isTrainer === 'true' ? 'Trainer' :
                 row.dataset.isStaff === 'true' ? 'Staff' : 'User';
    document.getElementById('viewRole').textContent = role;
    document.getElementById('viewGroups').textContent = row.dataset.groups || 'None';
    document.getElementById('viewModal').classList.remove('hidden');

  } else if (action === 'delete' && row) {
    document.getElementById('deleteUsername').textContent = row.dataset.username;
    document.getElementById('deleteUserId').value = userId;
    document.getElementById('deleteForm').action = "{% url 'user_delete' 999 %}".replace('999', userId);
    document.getElementById('deleteModal').classList.remove('hidden');
  }
}

function resetForm() {
  document.getElementById('userId').value = '';
  document.getElementById('username').value = '';
  document.getElementById('email').value = '';
  document.getElementById('password').value = '';
  document.getElementById('first_name').value = '';
  document.getElementById('last_name').value = '';
  document.getElementById('centre').value = '';
  if (canEditRoles) {
    const groups = document.getElementById('groups');
    if (groups) Array.from(groups.options).forEach(o => o.selected = false);
    ['is_trainer', 'is_staff', 'is_superuser'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.checked = false;
    });
  } else {
    document.getElementById('readonlyTrainer').textContent = 'No';
    document.getElementById('readonlyStaff').textContent = 'No';
    document.getElementById('readonlySuperuser').textContent = 'No';
    document.getElementById('readonlyItManager').textContent = 'No';
    document.getElementById('readonlySeniorOfficer').textContent = 'No';
    document.getElementById('readonlyGroups').textContent = 'None';
  }
}

function populateForm(row) {
  document.getElementById('userId').value = row.dataset.userId;
  document.getElementById('username').value = row.dataset.username;
  document.getElementById('email').value = row.dataset.email;
  document.getElementById('first_name').value = row.dataset.firstName;
  document.getElementById('last_name').value = row.dataset.lastName;
  document.getElementById('centre').value = row.dataset.centre || '';
  document.getElementById('password').value = '';

  if (canEditRoles) {
    const groupIds = row.dataset.groups ? row.dataset.groups.split(',').map(g => g.trim()) : [];
    const groupsSelect = document.getElementById('groups');
    if (groupsSelect) {
      Array.from(groupsSelect.options).forEach(o => o.selected = groupIds.includes(o.text));
    }
    document.getElementById('is_trainer').checked = row.dataset.isTrainer === 'true';
    document.getElementById('is_staff').checked = row.dataset.isStaff === 'true';
    document.getElementById('is_superuser').checked = row.dataset.isSuperuser === 'true';
  } else {
    document.getElementById('readonlyTrainer').textContent = row.dataset.isTrainer === 'true' ? 'Yes' : 'No';
    document.getElementById('readonlyStaff').textContent = row.dataset.isStaff === 'true' ? 'Yes' : 'No';
    document.getElementById('readonlySuperuser').textContent = row.dataset.isSuperuser === 'true' ? 'Yes' : 'No';
    document.getElementById('readonlyItManager').textContent = row.dataset.isItManager === 'true' ? 'Yes' : 'No';
    document.getElementById('readonlySeniorOfficer').textContent = row.dataset.isSeniorItOfficer === 'true' ? 'Yes' : 'No';
    document.getElementById('readonlyGroups').textContent = row.dataset.groups || 'None';
  }
}

function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
}

// Password required
document.getElementById('userForm').addEventListener('submit', function(e) {
  if (!document.getElementById('userId').value && !document.getElementById('password').value) {
    e.preventDefault();
    alert('Password is required for new users.');
  }
});

// Centre required for trainers
document.getElementById('is_trainer')?.addEventListener('change', updateCentreRequirement);
document.getElementById('is_superuser')?.addEventListener('change', updateCentreRequirement);

function updateCentreRequirement() {
  if (!canEditRoles) return;
  const isTrainer = document.getElementById('is_trainer').checked;
  const isSuperuser = document.getElementById('is_superuser').checked;
  document.getElementById('centre').required = isTrainer && !isSuperuser;
}
</script>
{% endblock %}