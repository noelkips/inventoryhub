{% extends 'dashboard.html' %}

{% block content %}

{% load static %}

<script type="text/javascript">
    function openModal(modalId) {
        console.log('Opening modal:', modalId);
        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
        console.log('Closing modal:', modalId);
        document.getElementById(modalId).classList.add('hidden');
    }

    function updateItemsPerPage(select) {
        const itemsPerPage = select.value;
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('items_per_page', itemsPerPage);
        urlParams.set('page', 1);
        window.location.href = "{% url 'ppm_report' %}?" + urlParams.toString();
    }
</script>

<div class="container mx-auto p-4 lg:p-6">

    <!-- Header -->
    <div class="mb-8 animate-fade-in">
        <h1 class="text-4xl font-bold text-primary mb-2">
            PPM Report {% if current_period %}for {{ current_period.name }}{% endif %}
        </h1>
        <p class="text-gray-600">Detailed overview of PPM tasks and performance.</p>
    </div>

    <!-- Action Buttons -->
    <div class="bg-gradient-to-r from-blue-800 to-blue-600 p-6 rounded-2xl shadow-xl mb-8 animate-slide-up">
        <h3 class="text-white text-lg font-semibold mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"></path>
            </svg>
            Quick Actions
        </h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
            <a href="{% url 'dashboard' %}" class="group bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform">
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium">Back to Dashboard</span>
            </a>
            <a href="?export=pdf&period={{ period_filter }}&centre={{ centre_filter }}&search={{ search_query }}" class="group bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform">
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium">Export PDF</span>
            </a>
            <a href="?export=excel&period={{ period_filter }}&centre={{ centre_filter }}&search={{ search_query }}" class="group bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform">
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium">Export Excel</span>
            </a>
            <a href="{% url 'ppm_history' %}" class="group bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 text-white px-4 py-3 rounded-xl transition duration-300 flex flex-col items-center justify-center text-center shadow-lg hover:shadow-2xl hover:-translate-y-1 transform">
                <svg class="w-8 h-8 mb-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium">PPM History</span>
            </a>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        <div class="mb-6 animate-slide-down">
            {% for message in messages %}
                <div class="bg-{% if message.tags == 'error' %}red{% else %}green{% endif %}-100 border-l-4 border-{% if message.tags == 'error' %}red{% else %}green{% endif %}-500 text-{% if message.tags == 'error' %}red{% else %}green{% endif %}-700 px-6 py-4 rounded-lg shadow-md mb-4 flex items-center" role="alert">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        {% if message.tags == 'error' %}
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        {% else %}
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        {% endif %}
                    </svg>
                    <span>{{ message }}</span>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-accent transform hover:-translate-y-1 animate-scale-in">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Total Devices</p>
                    <p class="text-4xl font-bold text-accent mb-2">{{ approved_devices }}</p>
                    <p class="text-xs text-gray-500 mt-2">Eligible for PPM</p>
                </div>
                <div class="bg-accent bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-accent" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-green-500 transform hover:-translate-y-1 animate-scale-in" style="animation-delay: 0.1s;">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Completed PPM</p>
                    <p class="text-4xl font-bold text-green-600 mb-2">{{ devices_with_ppm }}</p>
                    <p class="text-xs text-gray-600">On time: {{ completed_on_time }}</p>
                </div>
                <div class="bg-green-500 bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-secondary transform hover:-translate-y-1 animate-scale-in" style="animation-delay: 0.2s;">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Completion Rate</p>
                    <p class="text-4xl font-bold text-secondary mb-2">{{ ppm_completion_rate }}%</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="bg-secondary rounded-full h-2 transition-all duration-500" style="width: {{ ppm_completion_rate }}%"></div>
                    </div>
                    <p class="text-xs text-gray-600">{{ devices_with_ppm }} / {{ approved_devices }}</p>
                </div>
                <div class="bg-secondary bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-secondary" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="group bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-yellow-500 transform hover:-translate-y-1 animate-scale-in" style="animation-delay: 0.3s;">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide mb-1">Overdue Tasks</p>
                    <p class="text-4xl font-bold text-yellow-600 mb-2">{{ overdue_tasks }}</p>
                    <p class="text-xs text-gray-600">Due soon: {{ tasks_due_soon }}</p>
                    {% if avg_completion_time %}
                    <p class="text-xs text-gray-500 mt-1">Avg time: {{ avg_completion_time }} days</p>
                    {% endif %}
                </div>
                <div class="bg-yellow-500 bg-opacity-10 p-3 rounded-xl group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
        <h3 class="text-lg font-bold text-primary mb-4">Filters</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
                <label for="period" class="block text-sm font-medium text-gray-700 mb-2">Period:</label>
                <select name="period" id="period" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent" onchange="window.location.href='{% url 'ppm_report' %}?period='+this.value+'&centre={{ centre_filter }}&items_per_page={{ items_per_page }}&search={{ search_query }}'">
                    {% for period in periods %}
                        <option value="{{ period.id }}" {% if period_filter == period.id|stringformat:"s" %}selected{% endif %}>
                            {{ period.name }} ({{ period.start_date|date:"M d, Y" }} - {{ period.end_date|date:"M d, Y" }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="centre" class="block text-sm font-medium text-gray-700 mb-2">Centre:</label>
                <select name="centre" id="centre" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent" onchange="window.location.href='{% url 'ppm_report' %}?centre='+this.value+'&period={{ period_filter }}&items_per_page={{ items_per_page }}&search={{ search_query }}'">
                    <option value="">All Centres</option>
                    {% for centre in centres %}
                        <option value="{{ centre.id }}" {% if centre_filter == centre.id|stringformat:"s" %}selected{% endif %}>
                            {{ centre.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Search:</label>
                <input type="text" name="search" id="search" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent" value="{{ search_query }}" placeholder="Serial, assignee, dept..." onchange="window.location.href='{% url 'ppm_report' %}?search='+encodeURIComponent(this.value)+'&period={{ period_filter }}&centre={{ centre_filter }}&items_per_page={{ items_per_page }}'">
            </div>
            <div>
                <label for="items_per_page" class="block text-sm font-medium text-gray-700 mb-2">Items per Page:</label>
                <select name="items_per_page" id="items_per_page" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent" onchange="updateItemsPerPage(this)">
                    {% for size in items_per_page_options %}
                        <option value="{{ size }}" {% if items_per_page|add:"0" == size|add:"0" %}selected{% endif %}>
                            {{ size }} per page
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="window.location.href='{% url 'ppm_report' %}'" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                    Clear Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- PPM Status -->
        {% if ppm_status_labels %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-primary">PPM Status</h3>
                <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Live</span>
            </div>
            <div class="relative" style="height: 280px;">
                <canvas id="ppmStatusChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Device Condition -->
        {% if device_condition_breakdown %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-primary">Device Condition</h3>
                <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Live</span>
            </div>
            <div class="relative" style="height: 280px;">
                <canvas id="deviceConditionChart"></canvas>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Distribution Lists -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- PPM by Centre -->
        {% if ppm_by_centre %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-slide-up">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
                PPM by Centre
            </h3>
            <div class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                {% for item in ppm_by_centre %}
                <div class="p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl hover:from-green-50 hover:to-green-100 transition-all duration-300 border-l-4 border-green-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-gray-800">{{ item.device__centre__name|default:"Unassigned" }}</span>
                        <span class="text-xs bg-white px-3 py-1 rounded-full text-gray-600 font-medium">{{ item.total }} devices</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-2">
                        <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: {% if item.total > 0 %}{% widthratio item.completed item.total 100 %}{% else %}0{% endif %}%">
                            <span class="text-xs text-white font-bold">{% if item.total > 0 %}{% widthratio item.completed item.total 100 %}{% else %}0{% endif %}%</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600">{{ item.completed }} completed</p>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm text-center py-4">No data available</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Top Activities -->
        {% if ppm_tasks_by_activity %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-slide-up" style="animation-delay: 0.1s;">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                </svg>
                Top Activities
            </h3>
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                {% for item in ppm_tasks_by_activity %}
                <div class="group p-3 bg-gray-50 hover:bg-gradient-to-r hover:from-purple-500 hover:to-purple-600 rounded-xl transition-all duration-300 cursor-pointer">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700 group-hover:text-white transition-colors flex-1">{{ item.activities__name|default:"Unspecified" }}</span>
                        <span class="text-sm font-bold text-purple-600 group-hover:text-white transition-colors ml-2">{{ item.count }}</span>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm text-center py-4">No activities recorded</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Recent Completions and Task List -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Recent PPM Completions -->
        {% if recent_ppm_completions %}
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                Recent PPM Completions
            </h3>
            <div class="overflow-x-auto max-h-96 custom-scrollbar">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Device SN</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Centre</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Completed</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for task in recent_ppm_completions %}
                        <tr class="hover:bg-green-50 transition-colors duration-200">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-800">{{ task.device.serial_number|default:"N/A" }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ task.device.centre.name|default:"N/A" }}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">{{ task.completed_date|date:"M d, Y" }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500 text-sm">No recent completions</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Task List Preview (First few) -->
        <div class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 animate-fade-in" style="animation-delay: 0.1s;">
            <h3 class="text-lg font-bold text-primary mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-accent" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                </svg>
                Task List Preview
                <span class="ml-auto text-xs bg-accent text-white px-3 py-1 rounded-full">Showing {{ tasks|length }}</span>
            </h3>
            <div class="overflow-x-auto max-h-96 custom-scrollbar">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Device SN</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Centre</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for task in tasks|slice:":10" %}
                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-800">{{ task.device.serial_number|default:"N/A" }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ task.device.centre.name|default:"N/A" }}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="inline-block px-2 py-1 rounded text-xs font-semibold {% if task.completed_date %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {% if task.completed_date %}Completed{% else %}Incomplete{% endif %}
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500 text-sm">No tasks found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <a href="#full-task-list" class="block text-center text-accent hover:text-blue-700 font-medium text-sm mt-4 py-2 hover:underline transition-colors">View Full Task List â†“</a>
        </div>
    </div>

    <!-- Full Task List -->
    <div id="full-task-list" class="bg-white rounded-2xl shadow-md overflow-hidden mb-8">
        <div class="p-6">
            <h3 class="text-xl font-bold text-primary mb-4">Full PPM Task List</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-primary text-white">
                        <th class="py-4 px-4 text-left text-sm font-semibold">Device Details</th>
                        <th class="py-4 px-4 text-left text-sm font-semibold">Centre</th>
                        <th class="py-4 px-4 text-left text-sm font-semibold">Assignee</th>
                        <th class="py-4 px-4 text-left text-sm font-semibold">Status & Date</th>
                        <th class="py-4 px-4 text-left text-sm font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for task in tasks %}
                        <tr class="hover:bg-gray-50 transition duration-150">
                            <td class="py-3 px-4">
                                <p class="text-sm"><strong class="text-primary">Serial:</strong> {{ task.device.serial_number|default:"N/A" }}</p>
                                <p class="text-sm text-gray-600"><strong>Hardware:</strong> {{ task.device.hardware|default:"N/A" }}</p>
                            </td>
                            <td class="py-3 px-4 text-sm text-gray-700">{{ task.device.centre.name|default:"N/A" }}</td>
                            <td class="py-3 px-4 text-sm text-gray-700">{{ task.device.assignee_first_name|default:"N/A" }} {{ task.device.assignee_last_name|default:"" }}</td>
                            <td class="py-3 px-4">
                                <p class="text-sm">
                                    <span class="inline-block px-2 py-1 rounded text-xs font-semibold {% if task.completed_date %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {% if task.completed_date %}Completed{% else %}Incomplete{% endif %}
                                    </span>
                                </p>
                                <p class="text-xs text-gray-600 mt-1">{{ task.completed_date|date:'M d, Y'|default:"Not completed" }}</p>
                            </td>
                            <td class="py-3 px-4">
                                <div class="flex space-x-2">
                                    <button class="bg-accent text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition duration-200 text-sm" onclick="openModal('viewModal{{ task.id }}')">View</button>
                                    
                                </div>
                            </td>
                        </tr>

                        <!-- View Modal -->
                        <div id="viewModal{{ task.id }}" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                            <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
                                <div class="bg-gradient-to-r from-primary to-accent text-white p-6 rounded-t-xl flex justify-between items-center">
                                    <h3 class="text-2xl font-bold">PPM Task Details</h3>
                                    <button onclick="closeModal('viewModal{{ task.id }}')" class="text-white hover:text-gray-200 text-3xl font-bold leading-none">&times;</button>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div class="space-y-3">
                                            <h4 class="font-bold text-primary border-b pb-2">Device Information</h4>
                                            <p class="text-sm"><strong class="text-gray-700">Centre:</strong> {{ task.device.centre.name|default:"N/A" }}</p>
                                            <p class="text-sm"><strong class="text-gray-700">Department:</strong> {{ task.device.department.name|default:"N/A" }}</p>
                                            <p class="text-sm"><strong class="text-gray-700">Serial Number:</strong> {{ task.device.serial_number|default:"N/A" }}</p>
                                            <p class="text-sm"><strong class="text-gray-700">Hardware:</strong> {{ task.device.hardware|default:"N/A" }}</p>
                                        </div>
                                        <div class="space-y-3">
                                            <h4 class="font-bold text-primary border-b pb-2">Assignment Details</h4>
                                            <p class="text-sm"><strong class="text-gray-700">Assignee:</strong> {{ task.device.assignee_first_name|default:"N/A" }} {{ task.device.assignee_last_name|default:"" }}</p>
                                            <p class="text-sm"><strong class="text-gray-700">Email:</strong> {{ task.device.assignee_email_address|default:"N/A" }}</p>
                                            <p class="text-sm"><strong class="text-gray-700">Created By:</strong> {{ task.created_by.username|default:"N/A" }}</p>
                                            <p class="text-sm"><strong class="text-gray-700">Created At:</strong> {{ task.created_at|date:"M d, Y H:i"|default:"N/A" }}</p>
                                        </div>
                                        <div class="space-y-3">
                                            <h4 class="font-bold text-primary border-b pb-2">Task Information</h4>
                                            <p class="text-sm"><strong class="text-gray-700">Status:</strong> 
                                                <span class="inline-block px-2 py-1 rounded text-xs font-semibold {% if task.completed_date %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                                    {% if task.completed_date %}Completed{% else %}Incomplete{% endif %}
                                                </span>
                                            </p>
                                            <p class="text-sm"><strong class="text-gray-700">Completed Date:</strong> {{ task.completed_date|date:'M d, Y'|default:"Not completed" }}</p>
                                            <p class="text-sm"><strong class="text-gray-700">Period:</strong> {{ task.period.name|default:"N/A" }}</p>
                                        </div>
                                    </div>
                                    <div class="mt-6">
                                        <h4 class="font-bold text-primary border-b pb-2 mb-3">Activities Performed</h4>
                                        <div class="flex flex-wrap gap-2">
                                            {% for activity in task.activities.all %}
                                                <span class="bg-accent text-white px-3 py-1 rounded-full text-sm">{{ activity.name }}</span>
                                            {% empty %}
                                                <span class="text-gray-500 text-sm">No activities recorded</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="mt-6">
                                        <h4 class="font-bold text-primary border-b pb-2 mb-3">Remarks</h4>
                                        <p class="text-sm text-gray-700 bg-gray-50 p-4 rounded-lg">{{ task.remarks|default:"No remarks" }}</p>
                                    </div>
                                    <div class="mt-6 flex justify-end">
                                        <button class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition duration-200" onclick="closeModal('viewModal{{ task.id }}')">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Modal (Placeholder) -->
                        {% if user.is_superuser %}
                        <div id="editModal{{ task.id }}" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl">
                                <div class="bg-gradient-to-r from-primary to-accent text-white p-6 rounded-t-xl flex justify-between items-center">
                                    <h3 class="text-2xl font-bold">Edit PPM Task</h3>
                                    <button onclick="closeModal('editModal{{ task.id }}')" class="text-white hover:text-gray-200 text-3xl font-bold leading-none">&times;</button>
                                </div>
                                <div class="p-6">
                                    <p class="text-gray-600 mb-4">Edit functionality will be implemented soon.</p>
                                    <div class="flex justify-end">
                                        <button class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition duration-200" onclick="closeModal('editModal{{ task.id }}')">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Delete Modal (Placeholder) -->
                        {% if user.is_superuser %}
                        <div id="deleteModal{{ task.id }}" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                                <div class="bg-error text-white p-6 rounded-t-xl">
                                    <h3 class="text-xl font-bold">Confirm Deletion</h3>
                                </div>
                                <div class="p-6">
                                    <p class="text-gray-700 mb-4">Are you sure you want to delete this PPM task?</p>
                                    <p class="text-sm text-gray-600"><strong>Serial:</strong> {{ task.device.serial_number|default:"N/A" }}</p>
                                    <p class="text-sm text-gray-600 mb-4"><strong>Period:</strong> {{ task.period.name|default:"N/A" }}</p>
                                    <div class="flex space-x-3 justify-end">
                                        <button class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition duration-200" onclick="closeModal('deleteModal{{ task.id }}')">Cancel</button>
                                        <button class="bg-error text-white px-6 py-2 rounded-lg hover:bg-red-700 transition duration-200" onclick="alert('Delete functionality will be implemented soon.'); closeModal('deleteModal{{ task.id }}')">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    {% empty %}
                        <tr>
                            <td colspan="5" class="py-8 text-center text-gray-500">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="mt-2 text-sm">No PPM tasks found matching your criteria.</p>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if paginator.num_pages > 1 or tasks %}
            <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                <div class="flex-1 flex justify-between sm:hidden">
                    {% if tasks.has_previous %}
                        <a href="?page={{ tasks.previous_page_number }}&period={{ period_filter }}&centre={{ centre_filter }}&items_per_page={{ items_per_page }}&search={{ search_query|urlencode }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>
                    {% endif %}
                    {% if tasks.has_next %}
                        <a href="?page={{ tasks.next_page_number }}&period={{ period_filter }}&centre={{ centre_filter }}&items_per_page={{ items_per_page }}&search={{ search_query|urlencode }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>
                    {% endif %}
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            Showing <span class="font-medium">{{ tasks.start_index }}</span> to <span class="font-medium">{{ tasks.end_index }}</span> of <span class="font-medium">{{ total_tasks }}</span> results
                        </p>
                    </div>
                    {% if paginator.num_pages > 1 %}
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            {% if tasks.has_previous %}
                                <a href="?page=1&period={{ period_filter }}&centre={{ centre_filter }}&items_per_page={{ items_per_page }}&search={{ search_query|urlencode }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span>First</span>
                                </a>
                                <a href="?page={{ tasks.previous_page_number }}&period={{ period_filter }}&centre={{ centre_filter }}&items_per_page={{ items_per_page }}&search={{ search_query|urlencode }}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span>&lsaquo;</span>
                                </a>
                            {% endif %}
                            
                            {% for num in paginator.page_range %}
                                {% if num >= tasks.number|add:-2 and num <= tasks.number|add:2 %}
                                    <a href="?page={{ num }}&period={{ period_filter }}&centre={{ centre_filter }}&items_per_page={{ items_per_page }}&search={{ search_query|urlencode }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 {% if num == tasks.number %}bg-accent text-white{% else %}bg-white text-gray-700 hover:bg-gray-50{% endif %} text-sm font-medium">
                                        {{ num }}
                                    </a>
                                {% endif %}
                            {% endfor %}
                            
                            {% if tasks.has_next %}
                                <a href="?page={{ tasks.next_page_number }}&period={{ period_filter }}&centre={{ centre_filter }}&items_per_page={{ items_per_page }}&search={{ search_query|urlencode }}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span>&rsaquo;</span>
                                </a>
                                <a href="?page={{ paginator.num_pages }}&period={{ period_filter }}&centre={{ centre_filter }}&items_per_page={{ items_per_page }}&search={{ search_query|urlencode }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span>Last</span>
                                </a>
                            {% endif %}
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>

</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js default configuration
    Chart.defaults.font.family = "'Inter', 'system-ui', 'sans-serif'";
    Chart.defaults.plugins.legend.labels.usePointStyle = true;
    Chart.defaults.plugins.legend.labels.padding = 15;
    Chart.defaults.plugins.legend.labels.pointStyle = 'circle';

    // PPM Status Chart
    {% if ppm_status_labels %}
    const ppmStatusCtx = document.getElementById('ppmStatusChart').getContext('2d');
    new Chart(ppmStatusCtx, {
        type: 'bar',
        data: {
            labels: [{% for label in ppm_status_labels %}'{{ label }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Tasks',
                data: [{% for data in ppm_status_data %}{{ data }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [{% for color in ppm_status_colors %}'{{ color }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                borderRadius: 10,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: { font: { size: 11 } }
                },
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 11 } }
                }
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 }
                }
            }
        }
    });
    {% endif %}

    // Device Condition Chart
    {% if device_condition_breakdown %}
    const deviceConditionCtx = document.getElementById('deviceConditionChart').getContext('2d');
    new Chart(deviceConditionCtx, {
        type: 'pie',
        data: {
            labels: [{% for item in device_condition_breakdown %}'{{ item.device_condition|default:"Unknown" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in device_condition_breakdown %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#8B5CF6', '#EC4899'],
                borderWidth: 3,
                borderColor: '#fff',
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 11 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            return ` ${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>

<style>
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-up {
        animation: slideUp 0.6s ease-out forwards;
        opacity: 0;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-down {
        animation: slideDown 0.4s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .animate-fade-in {
        animation: fadeIn 0.8s ease-in forwards;
        opacity: 0;
    }

    @keyframes scaleIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }
    .animate-scale-in {
        animation: scaleIn 0.5s ease-out forwards;
        opacity: 0;
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #288CC8;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #1e6a96;
    }

    /* Smooth transitions for all interactive elements */
    a, button, .group {
        transition: all 0.3s ease;
    }
</style>

{% endblock content %}